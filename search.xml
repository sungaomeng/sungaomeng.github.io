<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Pythonæ£€æµ‹è´Ÿè½½å‡è¡¡å¹¶è‡ªåŠ¨æ›´æ–°</title>
      <link href="/python/check-lb-auto-repair/"/>
      <url>/python/check-lb-auto-repair/</url>
      
        <content type="html"><![CDATA[<h2 id="Pythonæ£€æµ‹è´Ÿè½½å‡è¡¡å¹¶è‡ªåŠ¨æ›´æ–°"><a href="#Pythonæ£€æµ‹è´Ÿè½½å‡è¡¡å¹¶è‡ªåŠ¨æ›´æ–°" class="headerlink" title="Pythonæ£€æµ‹è´Ÿè½½å‡è¡¡å¹¶è‡ªåŠ¨æ›´æ–°"></a>Pythonæ£€æµ‹è´Ÿè½½å‡è¡¡å¹¶è‡ªåŠ¨æ›´æ–°</h2><h5 id="é¡¹ç›®åœ°å€-GitHub"><a href="#é¡¹ç›®åœ°å€-GitHub" class="headerlink" title="é¡¹ç›®åœ°å€ GitHub"></a>é¡¹ç›®åœ°å€ <a href="https://github.com/sungaomeng/ssproxy-repair" target="_blank" rel="noopener">GitHub</a></h5><h3 id="è„šæœ¬è¯´æ˜"><a href="#è„šæœ¬è¯´æ˜" class="headerlink" title="è„šæœ¬è¯´æ˜"></a>è„šæœ¬è¯´æ˜</h3><p>è¿™ä¸ªè„šæœ¬æ˜¯ç”¨æ¥è‡ªåŠ¨ä¿®å¤åŸºäºé˜¿é‡Œäº‘æ­å»ºçš„SsæœåŠ¡</p><ul><li><p>åœ¨é˜¿é‡Œäº‘æ–°åŠ å¡åœ°åŒºè´­ä¹°äº†ä¸€å°ä½é…ECS,æ­å»ºäº†SsæœåŠ¡ç«¯</p></li><li><p>ç”±äºé˜¿é‡Œäº‘ç»å¸¸å°æ€ç«¯å£æˆ–è€…å…¬ç½‘IPï¼Œæ‰€ä»¥æˆ‘å‰é¢ç”¨ä¸€ä¸ªå…¬ç½‘è´Ÿè½½å‡è¡¡ä½œä¸ºå…¥å£ (è¿™æ ·å°æ€çš„æ—¶å€™å°±æ˜¯å°æ€çš„è´Ÿè½½å‡è¡¡äº†)</p></li><li><p>è„šæœ¬æ£€æµ‹åˆ°è´Ÿè½½å‡è¡¡çš„ç«¯å£æˆ–è€…IPè¢«å°å, ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„è´Ÿè½½å‡è¡¡å¹¶å»ºç«‹ç›‘å¬ç«¯å£, ç„¶åæ›´æ–°DNSåŠHostsè®°å½•å¹¶åˆ é™¤æ—§è´Ÿè½½å‡è¡¡</p></li><li><p>ä¸€å¥—æµç¨‹ä¸‹æ¥, è™½ç„¶æœ‰ä¸€å®šçš„å»¶æ—¶, ä½†åŸºæœ¬èƒ½è‡ªåŠ¨åŒ–æ“ä½œä¿®å¤, ä¸ç”¨äººä¸ºå¹²é¢„äº†ã€‚</p><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3></li><li><p>å…¨éƒ¨åŸºäºé˜¿é‡Œäº‘</p></li><li><p>é˜¿é‡Œäº‘ECSã€è´Ÿè½½å‡è¡¡ã€äº‘è§£æDNS</p><h3 id="è„šæœ¬æµç¨‹"><a href="#è„šæœ¬æµç¨‹" class="headerlink" title="è„šæœ¬æµç¨‹"></a>è„šæœ¬æµç¨‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ requirements.txt</span><br><span class="line">â”œâ”€â”€ check.py <span class="comment"># æ£€æŸ¥ç›¸å…³å‡½æ•°, æ£€æŸ¥åŸŸåçš„ç«¯å£æ˜¯å¦æ­£å¸¸,é€šè¿‡åŸŸåè§£æIP</span></span><br><span class="line">â”œâ”€â”€ dns.py   <span class="comment"># é˜¿é‡Œäº‘äº‘è§£æDNSç›¸å…³å‡½æ•°, æŸ¥è¯¢/ä¿®æ”¹DNSè®°å½•, æ›´æ–°æœ¬åœ°Hosts</span></span><br><span class="line">â”œâ”€â”€ main.py  <span class="comment"># ä¸»ç¨‹åºå…¥å£,é›†åˆå…¶ä»–è„šæœ¬å‡½æ•°</span></span><br><span class="line">â””â”€â”€ slb.py   <span class="comment"># é˜¿é‡Œäº‘è´Ÿè½½å‡è¡¡ç›¸å…³å‡½æ•°, åˆ›å»º/åˆ é™¤è´Ÿè½½å‡è¡¡,åˆ›å»º/å¯åŠ¨ç›‘å¬ç«¯å£,æ·»åŠ åç«¯æœåŠ¡å™¨</span></span><br><span class="line"></span><br><span class="line">0 directories, 6 files</span><br></pre></td></tr></table></figure></li></ul><ol><li>main.pyä¸­å®šä¹‰é˜¿é‡Œäº‘ç›¸å…³å˜é‡ åŠ â€œhostâ€ å˜é‡ (è´Ÿè½½å‡è¡¡å…¬ç½‘IPå¯¹åº”çš„åŸŸå æˆ–è€…ç›´æ¥å†™IPï¼Œå¦‚æœå†™IPè¯·æ³¨é‡ŠDNSç›¸å…³å‡½æ•°è°ƒç”¨ï¼Œå»ºè®®åŸŸå)</li><li>æ£€æŸ¥åŸŸåå¯¹åº”ç«¯å£æ˜¯å¦æ­£å¸¸ï¼Œæ­£å¸¸åˆ™é€€å‡ºï¼Œå¦åˆ™æ–°å»ºè´Ÿè½½å‡è¡¡ã€æ·»åŠ åç«¯æœåŠ¡å™¨ã€å»ºç«‹ç›‘å¬ã€å¯åŠ¨ç›‘å¬</li><li>ç­‰å¾…10såå†æ¬¡æ£€æŸ¥æ–°è´Ÿè½½å‡è¡¡çš„IPå¯¹åº”ç«¯å£æ˜¯å¦æ­£å¸¸ï¼Œæ­£å¸¸åˆ™åˆ é™¤æ—§è´Ÿè½½å‡è¡¡å¹¶æ›´æ–°DNSåé€€å‡ºï¼Œå¦åˆ™æ‰“å°logåé€€å‡º</li></ol><h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><ul><li>Python 3 (æˆ‘çš„ç¯å¢ƒæ˜¯3.5.2)</li><li>Crontab</li><li>ä»¥åŠä¸€äº›pythonä¾èµ–è§requirements.txt</li></ul><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/sungaomeng/ssproxy-repair.git</span><br><span class="line">$ pip install -r ssproxy-repair/requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¡æ—¶</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"* * * * * /usr/sbin/ntpdate ntp.aliyun.com"</span> &gt;&gt; /var/spool/<span class="variable">$User</span></span><br><span class="line"><span class="comment"># æ¯åŠå°æ—¶æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"*/30 * * * * /usr/bin/python /root/ssproxy-repair/main.py &gt;&gt; /tmp/ssproxy-repair.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/<span class="variable">$User</span></span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h3><p>ç›®å‰å¹¶æ²¡æœ‰è¾“å‡ºåˆ°log, ä»…æ˜¯æ‰“å°åˆ°å‰å°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Domain:ss.roobo.net HostIp:161.**.**.186 Port:8388 is not open, return codeï¼š35</span><br><span class="line">Prepare to create a new load balancing, Please wait ...</span><br><span class="line">New LoadBalancer:lb-t4nupa5f9w2ynfzsqkjo1 create successful.</span><br><span class="line">New LoadBalancer:lb-t4nupa5f9w2ynfzsqkjo1 add backendserver:i-t4n190***y3d0 successful.</span><br><span class="line">New LoadBalancer:lb-t4nupa5f9w2ynfzsqkjo1 create listener port:8388 successful.</span><br><span class="line">New LoadBalancer:lb-t4nupa5f9w2ynfzsqkjo1 start listener port:8388 successful.</span><br><span class="line">Wait 10 seconds to check the new load balancing again ...</span><br><span class="line">New LoadBalancer:161.**.**.196 Port:8388 is open</span><br><span class="line">Old LoadBalancer:lb-t4n9hdg5***houyedj delete successful.</span><br><span class="line">DNS update record successful domain:ss.test.com, old ip:161.**.**.186, new ip:161.**.**.196</span><br><span class="line">Hosts update record successful domain:ss.test.com, new ip:161.**.**.196</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Shadowsocks </tag>
            
            <tag> wall </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixå‘Šè­¦æ”¶æ•›</title>
      <link href="/zabbix/zabbix-alarm-convergence-compression/"/>
      <url>/zabbix/zabbix-alarm-convergence-compression/</url>
      
        <content type="html"><![CDATA[<p>  ç”±äºæŠ¥è­¦çŸ­ä¿¡ã€é‚®ä»¶å¤ªå¤šå¯¼è‡´è¿ç»´äººå‘˜ç²¾ç¥é«˜åº¦ç´§å¼ ã€æ—¶é—´é•¿äº†å®¹æ˜“å¯¹é‡è¦å‘Šè­¦å¿½ç•¥ï¼Œå¼•èµ·ä¸å¿…è¦çš„éº»çƒ¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘åœ¨ç½‘ä¸Šå¼€å§‹æœç´¢å‘Šè­¦æ”¶æ•›ç›¸å…³çš„æ–‡ç« å°è¯•è§£å†³ï¼Œæœ€ç»ˆå—ç›Šäºâ€ç®€è¿°â€å¤§ç¥çš„è¿™ç¯‡æ–‡ç«  â€œ<a href="https://www.jianshu.com/p/b29cf0682b58" target="_blank" rel="noopener">zabbix å‘Šè­¦ | å‘Šè­¦æ”¶æ•›</a>â€œ çš„æ€è·¯ï¼Œäºæ˜¯åŸºäºå¤§ç¥çš„ä»£ç è¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹å¹¶å·²åº”ç”¨äºæˆ‘ä»¬å…¬å¸ç¯å¢ƒä¸­ä¸€å¹´ä»¥ä¸Šã€‚</p><p>ä¸‹é¢ä¸ºå¤§å®¶åˆ†äº«ä¸‹æ•´ä½“çš„æµç¨‹ä»¥åŠä»£ç ã€‚</p><h2 id="ä¸€ã€æ¶æ„å›¾"><a href="#ä¸€ã€æ¶æ„å›¾" class="headerlink" title="ä¸€ã€æ¶æ„å›¾"></a>ä¸€ã€æ¶æ„å›¾</h2><p>â‘ äº§ç”Ÿçš„æ‰€æœ‰å‘Šè­¦å‡ç”±zabbixçš„actionsè°ƒç”¨è„šæœ¬æ¨å…¥ç¼“å­˜rediså½“ä¸­ï¼›<br>â‘¡è„šæœ¬å°†æ¯åˆ†é’Ÿ(crontab)å»redisä¸­æ‹‰å–æ•°æ®ï¼Œæ ¹æ®å®šä¹‰å¥½çš„ä¸€ç³»åˆ—è§„åˆ™è¿›è¡Œåˆ†æã€åˆå¹¶ï¼›<br>â‘¢æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™å°†æŠ¥è­¦é€šè¿‡å®šä¹‰å¥½çš„æ–¹å¼å‘é€ç»™ç›¸å…³äººå‘˜ï¼›<br><img src="https://upload-images.jianshu.io/upload_images/6840999-d2f2ac64b0a907d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="zabbixæ”¶æ•›æµç¨‹å›¾.png"></p><h2 id="äºŒã€è®¾ç½®Zabbix"><a href="#äºŒã€è®¾ç½®Zabbix" class="headerlink" title="äºŒã€è®¾ç½®Zabbix"></a>äºŒã€è®¾ç½®Zabbix</h2><h4 id="1-é…ç½®Media-types"><a href="#1-é…ç½®Media-types" class="headerlink" title="1. é…ç½®Media types"></a>1. é…ç½®Media types</h4><ul><li>ä»…ä¼ é€’ subject</li><li>æˆ‘è¿™é‡Œå®šä¹‰äº†3ä¸ªMediatype åˆ†åˆ«ç”¨äºå‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€ä¼ä¸šå¾®ä¿¡(å…·ä½“å¯è‡ªè¡Œè°ƒæ•´) ï¼ˆ3ä¸ªé™¤äº†Nameä¸ä¸€æ ·ä¹‹å¤–å…¶ä»–é…ç½®(Script name/Script parameters)ä¿æŒä¸€è‡´ï¼‰</li><li>è„šæœ¬ â€œzabbix-police/police.pyâ€ ä¸»è¦åŠŸèƒ½æ˜¯å°†Subject(Eventid)å†™å…¥Redisï¼Œåé¢ä¼šå†™åˆ°<br><img src="https://upload-images.jianshu.io/upload_images/6840999-6f2c47f7073877af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Media type é…ç½®"><br><img src="https://upload-images.jianshu.io/upload_images/6840999-a893afe5c3e975a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¤šä¸ªMedia types"><h4 id="2-é…ç½®Actions"><a href="#2-é…ç½®Actions" class="headerlink" title="2. é…ç½®Actions"></a>2. é…ç½®Actions</h4></li><li>æˆ‘è¿™é‡Œä»¥æ¯ä¸ªTrigger severityä¸€ä¸ªActionsä¸¾ä¾‹ã€‚ï¼ˆå¯ä»¥æ ¹æ®ä¸åŒçš„HostGroupæˆ–è€…å…¶ä»–æ¡ä»¶è‡ªè¡Œé…ç½®å¤šä¸ªactionsï¼‰</li><li>Default subject ä¹‹æ‰€ä»¥ç”¨ â€œ{EVENT.ID}_1ã€{EVENT.ID}_0â€ä¸ºçš„æ˜¯ä¿æŒå”¯ä¸€æ€§ï¼Œ1ä»£è¡¨æ•…éšœã€0ä»£è¡¨æ¢å¤</li><li>Default sbject<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;EVENT.ID&#125;_1</span><br></pre></td></tr></table></figure></li><li>Default message<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">triggervalue|&#123;TRIGGER.VALUE&#125;</span><br><span class="line">hostname|&#123;HOSTNAME1&#125;</span><br><span class="line">ipaddress|&#123;IPADDRESS&#125;</span><br><span class="line">hostgroup|&#123;TRIGGER.HOSTGROUP.NAME&#125;</span><br><span class="line">triggerstatus|&#123;TRIGGER.STATUS&#125;</span><br><span class="line">triggerseverity|&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">triggername|&#123;TRIGGER.NAME&#125;</span><br><span class="line">triggerkey|&#123;TRIGGER.KEY1&#125;</span><br><span class="line">triggeritems|&#123;ITEM.NAME&#125;</span><br><span class="line">itemvalue|&#123;ITEM.VALUE&#125;</span><br><span class="line">eventid|&#123;EVENT.ID&#125;</span><br><span class="line">action|&#123;ACTION.NAME&#125;</span><br><span class="line">eventage|&#123;EVENT.AGE&#125;</span><br><span class="line">eventtime|&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br></pre></td></tr></table></figure></li><li>Recovery subject<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;EVENT.ID&#125;_0</span><br></pre></td></tr></table></figure></li><li>Recovery message<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">triggervalue|&#123;TRIGGER.VALUE&#125;</span><br><span class="line">hostname|&#123;HOSTNAME1&#125;</span><br><span class="line">ipaddress|&#123;IPADDRESS&#125;</span><br><span class="line">hostgroup|&#123;TRIGGER.HOSTGROUP.NAME&#125;</span><br><span class="line">triggerstatus|&#123;TRIGGER.STATUS&#125;</span><br><span class="line">triggerseverity|&#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">triggername|&#123;TRIGGER.NAME&#125;</span><br><span class="line">triggerkey|&#123;TRIGGER.KEY1&#125;</span><br><span class="line">triggeritems|&#123;ITEM.NAME&#125;</span><br><span class="line">itemvalue|&#123;ITEM.VALUE&#125;</span><br><span class="line">eventid|&#123;EVENT.ID&#125;</span><br><span class="line">action|&#123;ACTION.NAME&#125;</span><br><span class="line">eventage|&#123;EVENT.AGE&#125;</span><br><span class="line">eventtime|&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/6840999-e0b7ec8cc74a3e94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¤šä¸ªActions"><br><img src="https://upload-images.jianshu.io/upload_images/6840999-358cc0018d2f9d37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Actions-æ¡ä»¶é…ç½®"><br><img src="https://upload-images.jianshu.io/upload_images/6840999-d671fa5034d09cbd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Actions-Operationsé…ç½®"><br><img src="https://upload-images.jianshu.io/upload_images/6840999-5dbf6e040c89b9fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Actions-Recoveryé…ç½®"></p><h2 id="ä¸‰ã€é…ç½®-Zabbix-æœåŠ¡å™¨"><a href="#ä¸‰ã€é…ç½®-Zabbix-æœåŠ¡å™¨" class="headerlink" title="ä¸‰ã€é…ç½® Zabbix æœåŠ¡å™¨"></a>ä¸‰ã€é…ç½® Zabbix æœåŠ¡å™¨</h2><h4 id="1-å®‰è£…ç¯å¢ƒ"><a href="#1-å®‰è£…ç¯å¢ƒ" class="headerlink" title="1. å®‰è£…ç¯å¢ƒ"></a>1. å®‰è£…ç¯å¢ƒ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä¸‹è½½ä»£ç </span></span><br><span class="line">/etc/zabbix/alertscripts</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/sungaomeng/zabbix-police.git</span><br><span class="line"><span class="comment">#å®‰è£…ä¾èµ–</span></span><br><span class="line">yum install gcc python-devel</span><br><span class="line">pip install -r zabbix-police/requirements.txt</span><br></pre></td></tr></table></figure><h4 id="2-è„šæœ¬"><a href="#2-è„šæœ¬" class="headerlink" title="2. è„šæœ¬"></a>2. è„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ–‡ä»¶åˆ†å¸ƒ</span></span><br><span class="line">[root@zabbix-server01 alertscripts]<span class="comment"># tree zabbix-police </span></span><br><span class="line">zabbix-police</span><br><span class="line">â”œâ”€â”€ police.py    <span class="comment">#Actionè°ƒç”¨æ­¤å‡½æ•°, ç”¨äºå°†EventIDå†™å…¥Redis</span></span><br><span class="line">â”œâ”€â”€ allpolice.py <span class="comment">#ç»¼åˆå‡½æ•°, æ€»å…¥å£, ç”¨äºæ•´åˆå…¶ä»–è„šæœ¬, å®šæ—¶è¢«Crontabè°ƒç”¨</span></span><br><span class="line">â”œâ”€â”€ dbread.py    <span class="comment">#æ•°æ®åº“æŸ¥è¯¢å‡½æ•°, ç”¨äºæŸ¥è¯¢Redisã€Mysql, è·å–EventIDã€è·å–å‘Šè­¦å…·ä½“ä¿¡æ¯ã€Mediatypeè„šæœ¬å¯¹åº”å…³ç³»ã€æŸ¥è¯¢å‘Šè­¦æ¥æ”¶äººç­‰ä¿¡æ¯</span></span><br><span class="line">â”œâ”€â”€ police.conf  <span class="comment">#å®šä¹‰é…ç½®æ–‡ä»¶, åŒ…æ‹¬mysqlã€redisã€wechatã€emailã€smsã€logfileç­‰é…ç½®</span></span><br><span class="line">â”œâ”€â”€ modconf.py   <span class="comment">#åŠ è½½é…ç½®å‡½æ•°, ç”¨äºåŠ è½½é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ operation.py <span class="comment">#æ“ä½œå‡½æ•°, ç”¨äº1. æ¥æ”¶dbread.pyè¿”å›çš„å‘Šè­¦ã€æ¢å¤ä¿¡æ¯, è¿›è¡Œåˆå¹¶ã€å‹ç¼©å¤„ç†, å¹¶è¿”å›å¤„ç†ç»“æœ 2. å®šä¹‰å„å‘Šè­¦å‘é€è°ƒç”¨å‡½æ•°</span></span><br><span class="line">â”œâ”€â”€ send_wechat.py <span class="comment">#å‘Šè­¦å‘é€-å¾®ä¿¡å‡½æ•°</span></span><br><span class="line">â”œâ”€â”€ send_sms.py    <span class="comment">#å‘Šè­¦å‘é€-çŸ­ä¿¡å‡½æ•°</span></span><br><span class="line">â”œâ”€â”€ send_email.py  <span class="comment">#å‘Šè­¦å‘é€-é‚®ä»¶å‡½æ•°</span></span><br><span class="line">â”œâ”€â”€ requirements.txt <span class="comment">#ä¾èµ–</span></span><br><span class="line">â””â”€â”€ README.md</span><br></pre></td></tr></table></figure><h4 id="3-Crontab"><a href="#3-Crontab" class="headerlink" title="3. Crontab"></a>3. Crontab</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@zabbix-server01 zabbix-police]<span class="comment"># crontab -l </span></span><br><span class="line">* * * * * /usr/bin/python /etc/zabbix/alertscripts/zabbix-police/allpolice.py</span><br></pre></td></tr></table></figure><h2 id="å››ã€å‘Šè­¦æ•ˆæœ"><a href="#å››ã€å‘Šè­¦æ•ˆæœ" class="headerlink" title="å››ã€å‘Šè­¦æ•ˆæœ"></a>å››ã€å‘Šè­¦æ•ˆæœ</h2><p><img src="https://upload-images.jianshu.io/upload_images/6840999-51ce6a1e78579a96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="zabbixå‘Šè­¦æ”¶æ•›-é‚®ä»¶"></p><p><img src="https://upload-images.jianshu.io/upload_images/6840999-75da6dcdc1b5e56e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="zabbixå‘Šè­¦æ”¶æ•›-ä¼ä¸šå¾®ä¿¡å‘Šè­¦"><br><img src="https://upload-images.jianshu.io/upload_images/6840999-8fffe6cdf32a80af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="zabbixå‘Šè­¦-çŸ­ä¿¡"></p>]]></content>
      
      
      <categories>
          
          <category> Zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus-Operator å®‰è£…</title>
      <link href="/prometheus/install-prometheus-operator/"/>
      <url>/prometheus/install-prometheus-operator/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€Prometheus-Operator-ä»‹ç»"><a href="#ä¸€ã€Prometheus-Operator-ä»‹ç»" class="headerlink" title="ä¸€ã€Prometheus Operator ä»‹ç»"></a>ä¸€ã€Prometheus Operator ä»‹ç»</h2><p>kubernetesçš„ç›‘æ§ç³»ç»ŸPrometheus ç›¸ä¿¡å¤§å®¶åº”è¯¥éƒ½æ¯”è¾ƒäº†è§£, è¿™é‡Œä¸åšè¿‡å¤šä»‹ç», ç®€å•äº†è§£ä¸€ä¸‹å‡ ç‚¹å§</p><h4 id="1-Prometheus-ç®€ä»‹"><a href="#1-Prometheus-ç®€ä»‹" class="headerlink" title="1. Prometheus ç®€ä»‹"></a>1. Prometheus ç®€ä»‹</h4><h5 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h5><p>&nbsp;Prometheus ç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œä½†æ˜¯å…¶ä¸­è®¸å¤šç»„ä»¶æ˜¯å¯é€‰çš„ï¼š</p><ul><li>Prometheus Serverï¼šç”¨äºæŠ“å–æŒ‡æ ‡ã€å­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®</li><li>exporterï¼šæš´éœ²æŒ‡æ ‡è®©ä»»åŠ¡æ¥æŠ“</li><li>pushgatewayï¼špush çš„æ–¹å¼å°†æŒ‡æ ‡æ•°æ®æ¨é€åˆ°è¯¥ç½‘å…³</li><li>alertmanagerï¼šå¤„ç†æŠ¥è­¦çš„æŠ¥è­¦ç»„ä»¶</li><li>adhocï¼šç”¨äºæ•°æ®æŸ¥è¯¢<h5 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h5>ä¸‹å›¾æ˜¯ Prometheus å®˜æ–¹æä¾›çš„æ¶æ„åŠå…¶ä¸€äº›ç›¸å…³çš„ç”Ÿæ€ç³»ç»Ÿç»„ä»¶ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/6840999-0ac10e4495ae39e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="prometheus-architecture.png"></li></ul><h4 id="2-Operator-ç®€ä»‹"><a href="#2-Operator-ç®€ä»‹" class="headerlink" title="2. Operator ç®€ä»‹"></a>2. Operator ç®€ä»‹</h4><p>Operator æ˜¯ CoreOS æ¨å‡ºçš„æ—¨åœ¨ç®€åŒ–å¤æ‚æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†çš„æ¡†æ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ„ŸçŸ¥åº”ç”¨çŠ¶æ€çš„æ§åˆ¶å™¨ï¼Œé€šè¿‡æ‰©å±• Kubernetes API æ¥è‡ªåŠ¨åˆ›å»ºã€ç®¡ç†å’Œé…ç½®åº”ç”¨å®ä¾‹ã€‚</p><p>ä½ å¯ä»¥åœ¨ <a href="https://www.operatorhub.io/" target="_blank" rel="noopener">OperatorHub.io</a> ä¸ŠæŸ¥çœ‹ Kubernetes ç¤¾åŒºæ¨èçš„ä¸€äº› Operator èŒƒä¾‹ã€‚</p><h4 id="operator-æ¶æ„å›¾"><a href="#operator-æ¶æ„å›¾" class="headerlink" title="operator æ¶æ„å›¾"></a>operator æ¶æ„å›¾</h4><p><img src="https://upload-images.jianshu.io/upload_images/6840999-1c17359ea85c78a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="prometheus-operatoræ¶æ„å›¾"></p><h2 id="äºŒã€å®‰è£…ä¾èµ–"><a href="#äºŒã€å®‰è£…ä¾èµ–" class="headerlink" title="äºŒã€å®‰è£…ä¾èµ–"></a>äºŒã€å®‰è£…ä¾èµ–</h2><h4 id="å®‰è£…Helm"><a href="#å®‰è£…Helm" class="headerlink" title="å®‰è£…Helm"></a>å®‰è£…Helm</h4><h5 id="1-ä¸‹è½½Helm"><a href="#1-ä¸‹è½½Helm" class="headerlink" title="1. ä¸‹è½½Helm"></a>1. ä¸‹è½½Helm</h5><p>Hlemç‰ˆæœ¬æˆ‘ä½¿ç”¨çš„æ˜¯å½“å‰2ç‰ˆæœ¬ä¸­çš„æœ€æ–°ç‰ˆ 2.16.7ï¼Œå› ä¸ºå®˜æ–¹å»ºè®®ä½¿ç”¨2.14ä»¥ä¸Šç‰ˆæœ¬, ä¸ç„¶ä¼šæœ‰CRDç›¸å…³é—®é¢˜, å…·ä½“è§Github <a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" target="_blank" rel="noopener">prometheus-operator</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.16.7-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v2.16.7-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm linux-amd64/tiller /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure><h5 id="2-åˆ›å»ºRBAC"><a href="#2-åˆ›å»ºRBAC" class="headerlink" title="2. åˆ›å»ºRBAC"></a>2. åˆ›å»ºRBAC</h5><p>åˆ›å»ºæ–‡ä»¶rbac-tiller.yaml , å†…å®¹ä¸ºä¸‹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºRBAC</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f rbac-tiller.yaml</span><br></pre></td></tr></table></figure><h5 id="2-åˆå§‹åŒ–Helm"><a href="#2-åˆå§‹åŒ–Helm" class="headerlink" title="2. åˆå§‹åŒ–Helm"></a>2. åˆå§‹åŒ–Helm</h5><p>å› ä¸ºé»˜è®¤ä¸‹è½½gcr.ioä»“åº“çš„é•œåƒ, ç”±äºå¢™çš„åŸå› ä¸‹è½½å¤±è´¥, æ‰€ä»¥æˆ‘ä¸‹è½½åä¼ åˆ°äº†æˆ‘å¸ä»“åº“</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm init --service-account tiller --tiller-image registry.cn-beijing.aliyuncs.com/roobo/tiller:v2.16.7</span><br><span class="line">$ helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.16.7"</span>, GitCommit:<span class="string">"5f2584fd3d35552c4af26036f0c464191287986b"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.16.7"</span>, GitCommit:<span class="string">"5f2584fd3d35552c4af26036f0c464191287986b"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€å®‰è£…Prometheus-Operator"><a href="#ä¸‰ã€å®‰è£…Prometheus-Operator" class="headerlink" title="ä¸‰ã€å®‰è£…Prometheus-Operator"></a>ä¸‰ã€å®‰è£…Prometheus-Operator</h2><h4 id="1-åˆ›å»ºNamespace"><a href="#1-åˆ›å»ºNamespace" class="headerlink" title="1. åˆ›å»ºNamespace"></a>1. åˆ›å»ºNamespace</h4><p>(å°†ç›¸å…³PODséƒ½åˆ›å»ºåˆ°æ­¤NSä¸‹)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubelet create ns monitoring</span><br></pre></td></tr></table></figure><h4 id="2-å®‰è£…-prometheus-operator"><a href="#2-å®‰è£…-prometheus-operator" class="headerlink" title="2. å®‰è£… prometheus-operator"></a>2. å®‰è£… prometheus-operator</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm install --namespace monitoring  --name prometheus-operator stable/prometheus-operator</span><br></pre></td></tr></table></figure><h4 id="3-æŸ¥çœ‹ç›¸å…³PODs"><a href="#3-æŸ¥çœ‹ç›¸å…³PODs" class="headerlink" title="3. æŸ¥çœ‹ç›¸å…³PODs"></a>3. æŸ¥çœ‹ç›¸å…³PODs</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8smaster-01 ~]<span class="comment"># kubectl -n monitoring get po</span></span><br><span class="line">NAME                                                     READY     STATUS    RESTARTS   AGE</span><br><span class="line">alertmanager-prometheus-operator-alertmanager-0           2/2       Running   0          53m</span><br><span class="line">prometheus-operator-grafana-69bfccc949-h9s7x              2/2       Running   0          53m</span><br><span class="line">prometheus-operator-kube-state-metrics-7ddcbdb744-xzh9w   1/1       Running   0          53m</span><br><span class="line">prometheus-operator-operator-6d4f47dc49-9g9jr             2/2       Running   0          53m</span><br><span class="line">prometheus-operator-prometheus-node-exporter-h9c2p        1/1       Running   0          53m</span><br><span class="line">prometheus-operator-prometheus-node-exporter-jw2hn        1/1       Running   0          53m</span><br><span class="line">prometheus-operator-prometheus-node-exporter-mqq4p        1/1       Running   0          53m</span><br><span class="line">prometheus-operator-prometheus-node-exporter-zxcg5        1/1       Running   0          53m</span><br><span class="line">prometheus-prometheus-operator-prometheus-0               3/3       Running   1          53m</span><br><span class="line"></span><br><span class="line">[root@k8smaster-01 ~]<span class="comment"># kubectl -n monitoring get svc</span></span><br><span class="line">NAME                                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">alertmanager-operated                          ClusterIP   None            &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   53m</span><br><span class="line">prometheus-operated                            ClusterIP   None            &lt;none&gt;        9090/TCP                     53m</span><br><span class="line">prometheus-operator-alertmanager               ClusterIP   10.254.13.40    &lt;none&gt;        9093/TCP                     54m</span><br><span class="line">prometheus-operator-grafana                    ClusterIP   10.254.0.159    &lt;none&gt;        80/TCP                       54m</span><br><span class="line">prometheus-operator-kube-state-metrics         ClusterIP   10.254.43.177   &lt;none&gt;        8080/TCP                     54m</span><br><span class="line">prometheus-operator-operator                   ClusterIP   10.254.38.46    &lt;none&gt;        8080/TCP,443/TCP             54m</span><br><span class="line">prometheus-operator-prometheus                 ClusterIP   10.254.27.218   &lt;none&gt;        9090/TCP                     54m</span><br><span class="line">prometheus-operator-prometheus-node-exporter   ClusterIP   10.254.60.8     &lt;none&gt;        9100/TCP                     54m</span><br><span class="line"></span><br><span class="line">[root@k8smaster-01 ~]<span class="comment"># kubectl get crd</span></span><br><span class="line">NAME                                    CREATED AT</span><br><span class="line">alertmanagers.monitoring.coreos.com     2020-05-10T06:38:44Z</span><br><span class="line">podmonitors.monitoring.coreos.com       2020-05-10T06:38:51Z</span><br><span class="line">prometheuses.monitoring.coreos.com      2020-05-10T06:38:56Z</span><br><span class="line">prometheusrules.monitoring.coreos.com   2020-05-10T06:39:02Z</span><br><span class="line">servicemonitors.monitoring.coreos.com   2020-05-10T06:39:07Z</span><br><span class="line">thanosrulers.monitoring.coreos.com      2020-05-10T06:39:12Z</span><br></pre></td></tr></table></figure><h4 id="4-åˆ›å»ºIngress"><a href="#4-åˆ›å»ºIngress" class="headerlink" title="4. åˆ›å»ºIngress"></a>4. åˆ›å»ºIngress</h4><p>é»˜è®¤æƒ…å†µä¸‹Grafanaå¹¶ä¸èƒ½ç›´æ¥è®¿é—®, å¯ä»¥å°†svcæ”¹ä¸ºNodePortæ–¹å¼æˆ–è€…åˆ›å»ºIngress é€šè¿‡åŸŸåçš„æ–¹å¼è®¿é—®åˆ°, è¿™é‡Œä»¥Ingressä¸¾ä¾‹</p><h5 id="Yamlæ–‡ä»¶"><a href="#Yamlæ–‡ä»¶" class="headerlink" title="Yamlæ–‡ä»¶"></a>Yamlæ–‡ä»¶</h5><p>(å°†$DOMAINä¿®æ”¹ä¸ºè‡ªå·±çš„åŸŸå)</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-prometheus-operator-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">$DOMAIN</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">prometheus-operator-grafana</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€æ•ˆæœå›¾"><a href="#å››ã€æ•ˆæœå›¾" class="headerlink" title="å››ã€æ•ˆæœå›¾"></a>å››ã€æ•ˆæœå›¾</h2><p><img src="https://upload-images.jianshu.io/upload_images/6840999-da3df79ebd9f6c00.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="é¦–é¡µ"></p><p><img src="https://upload-images.jianshu.io/upload_images/6840999-e2d9a84543a942df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Pod"></p><p><img src="https://upload-images.jianshu.io/upload_images/6840999-f3c62891e3bf5201.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Cluster"></p>]]></content>
      
      
      <categories>
          
          <category> Prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é˜¿é‡Œäº‘ç»å…¸ç½‘ç»œç§æœ‰DNSæœåŠ¡(å†…ç½‘DNS)æ–¹æ¡ˆ</title>
      <link href="/dns/aliyun-classic-network-private-dns/"/>
      <url>/dns/aliyun-classic-network-private-dns/</url>
      
        <content type="html"><![CDATA[<h2 id="ç°çŠ¶"><a href="#ç°çŠ¶" class="headerlink" title="ç°çŠ¶"></a>ç°çŠ¶</h2><ul><li>æœ‰å†…ç½‘Hostéœ€æ±‚çš„å…¨éƒ¨é€šè¿‡ç»‘å®šHostsè®¿é—®(/etc/hosts)</li></ul><h2 id="ç—›ç‚¹"><a href="#ç—›ç‚¹" class="headerlink" title="ç—›ç‚¹"></a>ç—›ç‚¹</h2><ul><li>éœ€è¦æ‰‹åŠ¨ä¿®æ”¹hostsæ–‡ä»¶</li><li>ç»´æŠ¤éº»çƒ¦æ˜“å‡ºé”™</li><li>dockerç¯å¢ƒè¿˜éœ€è¦å•ç‹¬ç»™æ¯ä¸ªpodæ·»åŠ hostsé€‚é…,ä¸èƒ½åšåˆ°ç»Ÿä¸€ç®¡ç†</li></ul><h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><ul><li><p>ç»Ÿä¸€ç®¡ç†åŸŸåæ˜ å°„å…³ç³»</p></li><li><p>æœ€å¥½æ˜¯WEBç•Œé¢ç®¡ç†</p></li><li><p>åŸºç¡€æœåŠ¡è¦ä¿è¯ç¨³å®š</p></li><li><p>æ”¯æŒâ€<a href="https://help.aliyun.com/document_detail/107125.html" target="_blank" rel="noopener">é€’å½’è§£æä»£ç†</a>â€œ</p><ul><li>å› ä¸ºæˆ‘ä»¬æœ‰ç›¸åŒåŸŸåå†…å¤–ç½‘è§£æåˆ°ä¸åŒIPçš„åœºæ™¯(æœ€å¼€å§‹æ²¡æœ‰è§„åˆ’å¥½)</li><li>æ¯”å¦‚api.aliyun.com <ul><li>å…¬ç½‘è§£æåˆ°çš„æ˜¯1.1.1.1(å…¬ç½‘è´Ÿè½½å‡è¡¡)</li><li>å†…ç½‘é…ç½®çš„hostsæ˜¯10.1.1.1(å†…ç½‘è´Ÿè½½å‡è¡¡)</li></ul></li></ul></li></ul><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>  èµ·åˆæƒ³è‡ªå»ºBINDæä¾›DNSæœåŠ¡,ä¸è¿‡ç®€å•æµ‹è¯•äº†ä¸‹BIND,å‘ç°BINDå¹¶ä¸èƒ½æ»¡è¶³æˆ‘çš„éœ€æ±‚:<strong>ä¸æ”¯æŒé€’å½’è§£æä»£ç†åŠŸèƒ½</strong>, å› ä¸ºBINDçš„Zoneæ˜¯ç”±æœ¬åœ°å®Œå…¨ä»£ç†è§£æçš„,å¦‚æœæœ¬åœ°Zoneé…ç½®é‡Œä¸å­˜åœ¨å¯¹åº”çš„è®°å½•å°±ä¼šè¿”å›ä¸å­˜åœ¨,ä¸ä¼šå†å»å…¬ç½‘ä¸Šå»æ‰¾ç»“æœå¹¶è¿”å›.(æœ›å¤§ç¥æŒ‡ç‚¹)</p><p>  ä¸¾ä¸ªæ —å­ğŸŒ°:</p><p>  ä¾‹å¦‚ï¼ŒZoneåç§°ä¸º<strong>aliyun.com</strong>,åœ¨<strong>aliyun.com</strong>å†…é…ç½®äº†ä¸‰æ¡ç§æœ‰è®°å½•ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th align="left">ä¸»æœºè®°å½•</th><th align="left">ç±»å‹</th><th align="left">TTL</th><th align="left">è®°å½•å€¼</th></tr></thead><tbody><tr><td align="left">host01</td><td align="left">A</td><td align="left">60</td><td align="left">10.0.0.1</td></tr><tr><td align="left">host02</td><td align="left">A</td><td align="left">60</td><td align="left">10.0.0.2</td></tr><tr><td align="left">host03</td><td align="left">A</td><td align="left">60</td><td align="left">10.0.0.3</td></tr></tbody></table><ul><li>åœ¨VPCå†…æŸ¥è¯¢ <strong>host01.aliyun.com,host02.aliyun.com æˆ–è€… host03.aliyun.com</strong>æ—¶ï¼Œåˆ†åˆ«è¿”å›ç§æœ‰è®°å½•<strong>10.0.0.1,10.0.0.2,10.0.0.3</strong>ã€‚</li><li>åœ¨VPCå†…æŸ¥è¯¢ <a href="http://www.aliyun.com" target="_blank" rel="noopener">www.aliyun.com</a>, api.aliyun.com ,rds.aliyun.com**ç­‰å…¬å…±åŸŸåæ—¶ï¼Œè¿›è¡Œé€’å½’æŸ¥è¯¢ï¼Œä»¥äº’è”ç½‘å®é™…åŸŸåè§£æç»“æœä¸ºæœ€ç»ˆDNSå“åº”ç»“æœã€‚</li></ul><p>â€‹    ç°åœ¨å„å¤§äº‘å‚å•†éƒ½æ”¯æŒå†…ç½‘DNSè§£æï¼Œé˜¿é‡Œäº‘ç°åœ¨ä¹Ÿå‡ºäº†<strong>PrivateZone</strong>æœåŠ¡,ä¸è¿‡æ˜¯<strong>æ”¶è´¹ç‰ˆ</strong>,ä½†PrivateZoneæœ‰ä¸€ä¸ªé™åˆ¶å°±æ˜¯<strong>åªèƒ½ä¸“æœ‰ç½‘ç»œ(VPC)ä½¿ç”¨</strong>,è¿™å°±æ¯”è¾ƒå‘äº†,ä¸è¿‡ç»¼åˆçœ‹äº†ä¸‹PrivateZoneçš„åŠŸèƒ½,å‘ç°å®Œå…¨<strong>æ»¡è¶³æˆ‘çš„éœ€æ±‚</strong>,äºæ˜¯æƒ³æ–¹è®¾æ³•è®©è®©å®ƒæ”¯æŒç»å…¸ç½‘ç»œ</p><p>â€‹    (è¿™é‡Œè§£é‡Šä¸‹ä¸ºä»€ä¹ˆéå¾—è¦æ”¯æŒç»å…¸ç½‘ç»œ: æˆ‘ä»¬æœ€å¼€å§‹å°±æ˜¯ä½¿ç”¨ç»å…¸ç½‘ç»œ,80%ä¸šåŠ¡éƒ½åœ¨ä¸Šé¢,è®¡åˆ’è¿ç§»åˆ°VPCä½†è¿˜æ²¡å¼€å§‹å®æ–½,æ‰€ä»¥å…ˆè§£å†³DNSé—®é¢˜å†è¯´å§)</p><p>â€‹    ç»è¿‡ä¸é˜¿é‡Œäº‘æ²Ÿé€š,å‘ç°ä»–ä»¬å®˜æ–¹æ²¡æœ‰ä»€ä¹ˆå»ºè®®å¯ä»¥å®ç°,äºæ˜¯è‡ªå·±æå§~</p><h3 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h3><p><img src="https://upload-images.jianshu.io/upload_images/6840999-32d13a23e972e6c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="é˜¿é‡Œäº‘ç»å…¸ç½‘ç»œç§æœ‰DNSæœåŠ¡æ–¹æ¡ˆ.png"></p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><ul><li>PrivateZoneç»‘å®šVPCå,è¯¥VPCå†…çš„ä¸»æœºéƒ½å¯ä»¥æ”¯æŒè‡ªå®šä¹‰è§£æ</li><li>é€šè¿‡åœ¨VPCé‡Œæ­å»ºBIND ä»£ç†åˆ°PrivateZoneæœåŠ¡</li></ul><h2 id="æ­å»º"><a href="#æ­å»º" class="headerlink" title="æ­å»º"></a>æ­å»º</h2><h3 id="è´­ä¹°ç¡¬ä»¶èµ„æº"><a href="#è´­ä¹°ç¡¬ä»¶èµ„æº" class="headerlink" title="è´­ä¹°ç¡¬ä»¶èµ„æº"></a>è´­ä¹°ç¡¬ä»¶èµ„æº</h3><ol><li>åˆ›å»ºä¸€ä¸ªä¸“æœ‰ç½‘ç»œ(VPC)</li><li>åˆ›å»ºä¸€ä¸ªDNSæœåŠ¡(PrivateZone)</li><li>åˆ›å»ºé˜¿é‡Œäº‘æœåŠ¡å™¨(ECS)æ­å»ºBINDæœåŠ¡,æœ€ä½ä¸¤å°(ä¸»ä»æ¶æ„)</li><li>åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡(SLB)ç›‘å¬UDP53</li><li>åˆ›å»ºä¸€å°é˜¿é‡Œäº‘æœåŠ¡å™¨(ç»å…¸ç½‘ç»œ)(DNS å®¢æˆ·ç«¯)</li></ol><h3 id="Ansibleå®‰è£…BIND9-ä¸»ä»æ¶æ„"><a href="#Ansibleå®‰è£…BIND9-ä¸»ä»æ¶æ„" class="headerlink" title="Ansibleå®‰è£…BIND9 ä¸»ä»æ¶æ„"></a>Ansibleå®‰è£…BIND9 ä¸»ä»æ¶æ„</h3><p>ä»¥ä¸‹ä¸ºå®‰è£…è¿‡ç¨‹,å…·ä½“è§<a href="https://github.com/sungaomeng/ansible-dns.git" target="_blank" rel="noopener">GITHUB</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install ansible</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;sungaomeng&#x2F;ansible-dns.git</span><br><span class="line">cd ansible-dns</span><br><span class="line">ansible all -m ping</span><br><span class="line">ansible-playbook deploy.yml</span><br></pre></td></tr></table></figure><p>æ³¨æ„åœ¨æ‰§è¡Œplaybookå‰è¦ä¿®æ”¹ansible/hosts é…ç½®</p><ol><li><p>forwarder_list</p><ul><li><p>è½¬å‘dnsçš„åœ°å€åˆ—è¡¨</p></li><li><p>å°†å€¼ä¿®æ”¹ä¸ºbindæœºå™¨/etc/resolv.conf ä¸­çš„nameserveråœ°å€</p></li></ul></li></ol><ol start="2"><li><p>internal_list</p><ul><li>å†…éƒ¨ç½‘ç»œåœ°å€åˆ—è¡¨ï¼Œè¡¨ç¤ºå…è®¸é€’å½’æŸ¥è¯¢çš„å®¢æˆ·ç«¯åˆ—è¡¨ï¼Œä¸€èˆ¬ä¸ºå†…éƒ¨æœåŠ¡å™¨ipæ‰€åœ¨çš„ç½‘æ®µ</li><li>å°†å€¼ä¿®æ”¹ä¸ºå®¢æˆ·ç«¯IPæ®µ</li></ul></li><li><p>masters/slaves</p><ul><li>BINDä¸»ä»IPåœ°å€</li></ul></li><li><p>ansible_ssh_port/user/pass</p><ul><li>å¦‚æœæ²¡æœ‰é…ç½®SSHäº’ä¿¡å°±æŒ‡å®šSSHä¿¡æ¯</li></ul></li></ol><h2 id="å‹æµ‹"><a href="#å‹æµ‹" class="headerlink" title="å‹æµ‹"></a>å‹æµ‹</h2><h3 id="querperfå®‰è£…"><a href="#querperfå®‰è£…" class="headerlink" title="querperfå®‰è£…"></a>querperfå®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://downloads.isc.org/isc/bind9/9.9.4/bind-9.9.4.tar.gz</span><br><span class="line">tar zxvf bind-9.9.4.tar.gz</span><br><span class="line">cd bind-9.9.4/contrib/queryperf</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"><a href="#åˆ›å»ºæµ‹è¯•æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ–‡ä»¶"></a>åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim ./querytest.txt</span><br><span class="line">å†™å…¥ä»¥ä¸‹å†…å®¹</span><br><span class="line">www.baidu.com A</span><br><span class="line">æ‰§è¡Œ :1,$yå›è½¦p</span><br><span class="line">å¤åˆ¶åˆ°1wè¡Œ~</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œæµ‹è¯•"><a href="#æ‰§è¡Œæµ‹è¯•" class="headerlink" title="æ‰§è¡Œæµ‹è¯•"></a>æ‰§è¡Œæµ‹è¯•</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./queryperf -q 20 -d ./querytest.txt -s 192.168.50.158 -l 100</span><br></pre></td></tr></table></figure><h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å‹æµ‹æ¡ä»¶:</span><br><span class="line">  1. æ—¶é—´: 100ç§’</span><br><span class="line">  2. å¹¶å‘æ•°: 120</span><br><span class="line">  3. å‹æµ‹å¯¹è±¡: SLB-&gt;å•å°2æ ¸4G DNSæœåŠ¡å™¨</span><br><span class="line">ç»“æœ:</span><br><span class="line">  1. CPU 68%</span><br><span class="line">  2. Mem 1.5%</span><br><span class="line">  3. QPS 2.2W</span><br><span class="line">  4. RTT average: 0.003891 sec</span><br><span class="line"> </span><br><span class="line">å‹æµ‹æ¡ä»¶:</span><br><span class="line"> 1. æ—¶é—´: 100ç§’</span><br><span class="line"> 2. å¹¶å‘æ•°: 160</span><br><span class="line"> 3. å‹æµ‹å¯¹è±¡: SLB-&gt;å•å°2æ ¸4G DNSæœåŠ¡å™¨</span><br><span class="line">ç»“æœ:</span><br><span class="line">  1. CPU 75%</span><br><span class="line">  2. Mem 1.5%</span><br><span class="line">  3. QPS 3.1W</span><br><span class="line">  4. RTT average: 0.004834 sec</span><br></pre></td></tr></table></figure><p><strong>ï¼ˆç”Ÿäº§ç¯å¢ƒå…±æœ‰3å°æœåŠ¡é€šè¿‡SLBæä¾›æœåŠ¡,ä»¥ä¸Šç»“æœéœ€è¦*3æ‰æ˜¯çº¿ä¸Šçš„ç“¶é¢ˆï¼‰</strong></p><h2 id="åˆ‡æ¢"><a href="#åˆ‡æ¢" class="headerlink" title="åˆ‡æ¢"></a>åˆ‡æ¢</h2><p>å°†ç»å…¸ç½‘ç»œECSçš„/etc/resolv.conf nameserveråœ°å€æ”¹ä¸ºè´Ÿè½½å‡è¡¡åœ°å€å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> DNS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> aliyun </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…Canal HAé›†ç¾¤å¹¶è¾“å‡ºè‡³Kafka</title>
      <link href="/canal/install-canal-to-kafka-HACluster/"/>
      <url>/canal/install-canal-to-kafka-HACluster/</url>
      
        <content type="html"><![CDATA[<h4 id="canal"><a href="#canal" class="headerlink" title="canal"></a>canal</h4><p>   canal [kÉ™â€™nÃ¦l]**ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œä¸»è¦ç”¨é€”æ˜¯åŸºäº MySQL æ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹</p><p>æ—©æœŸé˜¿é‡Œå·´å·´å› ä¸ºæ­å·å’Œç¾å›½åŒæœºæˆ¿éƒ¨ç½²ï¼Œå­˜åœ¨è·¨æœºæˆ¿åŒæ­¥çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå®ç°æ–¹å¼ä¸»è¦æ˜¯åŸºäºä¸šåŠ¡ trigger è·å–å¢é‡å˜æ›´ã€‚ä» 2010 å¹´å¼€å§‹ï¼Œä¸šåŠ¡é€æ­¥å°è¯•æ•°æ®åº“æ—¥å¿—è§£æè·å–å¢é‡å˜æ›´è¿›è¡ŒåŒæ­¥ï¼Œç”±æ­¤è¡ç”Ÿå‡ºäº†å¤§é‡çš„æ•°æ®åº“å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ä¸šåŠ¡ã€‚</p><p>åŸºäºæ—¥å¿—å¢é‡è®¢é˜…å’Œæ¶ˆè´¹çš„ä¸šåŠ¡åŒ…æ‹¬</p><ul><li>æ•°æ®åº“é•œåƒ</li><li>æ•°æ®åº“å®æ—¶å¤‡ä»½</li><li>ç´¢å¼•æ„å»ºå’Œå®æ—¶ç»´æŠ¤(æ‹†åˆ†å¼‚æ„ç´¢å¼•ã€å€’æ’ç´¢å¼•ç­‰)</li><li>ä¸šåŠ¡ cache åˆ·æ–°</li><li>å¸¦ä¸šåŠ¡é€»è¾‘çš„å¢é‡æ•°æ®å¤„ç†</li></ul><p>å½“å‰çš„ canal æ”¯æŒæºç«¯ MySQL ç‰ˆæœ¬åŒ…æ‹¬ 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p><h4 id="canal-å·¥ä½œåŸç†"><a href="#canal-å·¥ä½œåŸç†" class="headerlink" title="canal å·¥ä½œåŸç†"></a>canal å·¥ä½œåŸç†</h4><ul><li>canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸º MySQL slave ï¼Œå‘ MySQL master å‘é€dump åè®®</li><li>MySQL master æ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æ¨é€ binary log ç»™ slave (å³ canal )</li><li>canal è§£æ binary log å¯¹è±¡(åŸå§‹ä¸º byte æµ)</li></ul><p>Git: <a href="https://github.com/alibaba/canal" target="_blank" rel="noopener">https://github.com/alibaba/canal</a></p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li><p>canal</p><ul><li>canal01 10.31.150.42</li><li>canal02 10.80.81.39</li></ul></li><li><p>kafka/zk</p><ul><li>192.168.52.146</li></ul></li><li><p>mysql</p><ul><li>****.mysql.rds.aliyuncs.com</li></ul></li></ul><h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><ul><li>å¯¹äºè‡ªå»º MySQL , éœ€è¦å…ˆå¼€å¯ Binlog å†™å…¥åŠŸèƒ½ï¼Œé…ç½® binlog-format ä¸º ROW æ¨¡å¼ï¼Œmy.cnf ä¸­é…ç½®å¦‚ä¸‹</li></ul>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin&#x3D;mysql-bin # å¼€å¯ binlog</span><br><span class="line">binlog-format&#x3D;ROW # é€‰æ‹© ROW æ¨¡å¼</span><br><span class="line">server_id&#x3D;1 # é…ç½® MySQL replaction éœ€è¦å®šä¹‰ï¼Œä¸è¦å’Œ canal çš„ slaveId é‡å¤</span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„ï¼šé’ˆå¯¹é˜¿é‡Œäº‘ RDS for MySQL , é»˜è®¤æ‰“å¼€äº† binlog , å¹¶ä¸”è´¦å·é»˜è®¤å…·æœ‰ binlog dump æƒé™ , ä¸éœ€è¦ä»»ä½•æƒé™æˆ–è€… binlog è®¾ç½®,å¯ä»¥ç›´æ¥è·³è¿‡è¿™ä¸€æ­¥</li></ul><ul><li><p>æˆæƒ canal é“¾æ¥ MySQL è´¦å·å…·æœ‰ä½œä¸º MySQL slave çš„æƒé™, å¦‚æœå·²æœ‰è´¦æˆ·å¯ç›´æ¥ grant</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER canal IDENTIFIED BY &#39;canal&#39;;  </span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;canal&#39;@&#39;%&#39;;</span><br><span class="line">-- GRANT ALL PRIVILEGES ON *.* TO &#39;canal&#39;@&#39;%&#39; ;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><ul><li><p>ä¸‹è½½ canal, è®¿é—® <a href="[https://github.com/alibaba/canal/releases]">release</a> é¡µé¢, é€‰æ‹©éœ€è¦çš„åŒ…ä¸‹è½½, å¦‚ä»¥ v1.1.3 ç‰ˆæœ¬ä¸ºä¾‹ </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;canal&#x2F;releases&#x2F;download&#x2F;canal-1.1.3&#x2F;canal.deployer-1.1.3.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>è§£å‹ç¼©</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;canal</span><br><span class="line">tar zxvf canal.deployer-$version.tar.gz  -C &#x2F;usr&#x2F;local&#x2F;canal</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>é…ç½®ä¿®æ”¹</p><ul><li><p>conf/example/instance.properties</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi conf&#x2F;example&#x2F;instance.properties</span><br><span class="line">#################################################</span><br><span class="line">## mysql serverId , v1.0.26+ will autoGen</span><br><span class="line"># canal.instance.mysql.slaveId&#x3D;</span><br><span class="line"></span><br><span class="line"># enable gtid use true&#x2F;false</span><br><span class="line">canal.instance.gtidon&#x3D;false</span><br><span class="line"></span><br><span class="line"># position info</span><br><span class="line">canal.instance.master.address&#x3D;****.mysql.rds.aliyuncs.com:3306 #æ”¹ä¸ºéœ€è¦åŒæ­¥çš„æ•°æ®åº“åœ°å€</span><br><span class="line">canal.instance.master.journal.name&#x3D;</span><br><span class="line">canal.instance.master.position&#x3D;</span><br><span class="line">canal.instance.master.timestamp&#x3D;</span><br><span class="line">canal.instance.master.gtid&#x3D;</span><br><span class="line"></span><br><span class="line"># rds oss binlog</span><br><span class="line">canal.instance.rds.accesskey&#x3D;</span><br><span class="line">canal.instance.rds.secretkey&#x3D;</span><br><span class="line">canal.instance.rds.instanceId&#x3D;</span><br><span class="line"></span><br><span class="line"># table meta tsdb info</span><br><span class="line">canal.instance.tsdb.enable&#x3D;true</span><br><span class="line">#canal.instance.tsdb.url&#x3D;jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;canal_tsdb</span><br><span class="line">#canal.instance.tsdb.dbUsername&#x3D;canal</span><br><span class="line">#canal.instance.tsdb.dbPassword&#x3D;canal</span><br><span class="line"></span><br><span class="line">#canal.instance.standby.address &#x3D;</span><br><span class="line">#canal.instance.standby.journal.name &#x3D;</span><br><span class="line">#canal.instance.standby.position &#x3D;</span><br><span class="line">#canal.instance.standby.timestamp &#x3D;</span><br><span class="line">#canal.instance.standby.gtid&#x3D;</span><br><span class="line"></span><br><span class="line"># username&#x2F;password</span><br><span class="line">canal.instance.dbUsername&#x3D;canal  #æ”¹ä¸ºæ•°æ®åº“è´¦æˆ·</span><br><span class="line">canal.instance.dbPassword&#x3D;****   #æ”¹ä¸ºæ•°æ®åº“å¯†ç </span><br><span class="line">canal.instance.connectionCharset &#x3D; UTF-8</span><br><span class="line"># enable druid Decrypt database password</span><br><span class="line">canal.instance.enableDruid&#x3D;false</span><br><span class="line">#canal.instance.pwdPublicKey&#x3D;MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5&#x2F;zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2&#x2F;JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line"># table regex</span><br><span class="line">canal.instance.filter.regex&#x3D;DBname.DBtable,DBname.DBtable #éœ€è¦åŒæ­¥çš„è¡¨,å¤šä¸ªè¡¨ç”¨é€—å·ç›¸éš”,ä¹Ÿå¯æŒ‡å®šåº“ä¸‹çš„å…¨éƒ¨è¡¨</span><br><span class="line"># table black regex</span><br><span class="line">canal.instance.filter.black.regex&#x3D;</span><br><span class="line"></span><br><span class="line"># mq config</span><br><span class="line">canal.mq.topic&#x3D;test #æŒ‡å®šåŒæ­¥åˆ°kafkaçš„å“ªä¸ªtopicä¸­</span><br><span class="line"># dynamic topic route by schema or table regex</span><br><span class="line">#canal.mq.dynamicTopic&#x3D;mytest1.user,mytest2\\..*,.*\\..*</span><br><span class="line">canal.mq.partition&#x3D;0 #é»˜è®¤è¾“å‡ºåˆ°kafka topicçš„å“ªä¸ªpartitionä¸­</span><br><span class="line"># hash partition config</span><br><span class="line">canal.mq.partitionsNum&#x3D;15 #topicçš„partitionæ€»æ•°,å¦‚æœcanal.mq.partitionHashä¸å¯ç”¨,åˆ™æ­¤é¡¹æ²¡ç”¨</span><br><span class="line">canal.mq.partitionHash&#x3D;.*\\..*:id #ä½¿ç”¨idä½œä¸ºhashå°†æ•°æ®åˆ†å¸ƒåˆ°$partitionsNumä¸ªåˆ†åŒºä¸­</span><br><span class="line">#################################################</span><br></pre></td></tr></table></figure></li><li><p>å…³äºmq config</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mqç›¸å…³å‚æ•°è§å®˜æ–¹è¯´æ˜ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;canal&#x2F;wiki&#x2F;Canal-Kafka-RocketMQ-QuickStart</span><br><span class="line">å…³äºtopic:</span><br><span class="line">    å¯ä»¥æŒ‡å®šæ­£åˆ™å°†ä¸åŒçš„æ•°æ®è¾“å‡ºåˆ°ä¸åŒçš„è¡¨ canal.mq.dynamicTopic</span><br><span class="line">  å¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™é»˜è®¤è¾“å‡ºåˆ°canal.mq.topicè¡¨ä¸­</span><br><span class="line">    </span><br><span class="line">  å…³äºpartition:</span><br><span class="line">    å¯ä»¥æ ¹æ®hashç®—æ³•å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªpartitionä¸­ canal.mq.partitionHash</span><br><span class="line">  å¦‚æœä¸æŒ‡å®šåˆ™é»˜è®¤è¾“å‡ºåˆ°canal.mq.partition&#x3D;0 0åˆ†åŒºä¸­,è¿™æ ·ä¼šå¯¼è‡´åªæœ‰0åˆ†åŒºæœ‰æ•°æ®</span><br><span class="line">    å› ä¸ºæˆ‘å¸å¯¹æ•°æ®é¡ºåºæ²¡æœ‰è¦æ±‚,ä¸ºäº†æé«˜ååé‡,æ‰€ä»¥å°†idä½œä¸ºhash å°†æ•°æ®å‡åŒ€çš„åˆ†å¸ƒåˆ°äº†15ä¸ªpartitionä¸­</span><br><span class="line">  hashå‰ï¼š</span><br><span class="line">    $ &#x2F;data01&#x2F;server&#x2F;kafka&#x2F;bin&#x2F;kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 192.168.52.146:9092 --topic test --time -1</span><br><span class="line">  test:0:37159</span><br><span class="line">    test:1:0</span><br><span class="line">  test:2:0</span><br><span class="line">    test:3:0</span><br><span class="line">  test:4:0</span><br><span class="line">    test:5:0</span><br><span class="line">    test:6:0</span><br><span class="line">    test:7:0</span><br><span class="line">    test:8:0</span><br><span class="line">    test:9:0</span><br><span class="line">    test:10:0</span><br><span class="line">    test:11:0</span><br><span class="line">    test:12:0</span><br><span class="line">    test:13:0</span><br><span class="line">    test:14:0</span><br><span class="line">    </span><br><span class="line">    hashä¹‹å:</span><br><span class="line">    $ &#x2F;data01&#x2F;server&#x2F;kafka&#x2F;bin&#x2F;kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 192.168.52.146:9092 --topic test --time -1</span><br><span class="line">    test:0:98791</span><br><span class="line">    test:1:2689</span><br><span class="line">    test:2:2727</span><br><span class="line">    test:3:2831</span><br><span class="line">    test:4:2740</span><br><span class="line">    test:5:2464</span><br><span class="line">    test:6:2782</span><br><span class="line">    test:7:2846</span><br><span class="line">    test:8:3229</span><br><span class="line">    test:9:3183</span><br><span class="line">    test:10:2698</span><br><span class="line">    test:11:2801</span><br><span class="line">    test:12:3252</span><br><span class="line">    test:13:2347</span><br><span class="line">    test:14:2990</span><br></pre></td></tr></table></figure></li><li><p>conf/canal.properties</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#################################################</span><br><span class="line">#########               common argument         #############</span><br></pre></td></tr></table></figure><p>#################################################<br>#canal.manager.jdbc.url=jdbc:mysql://127.0.0.1:3306/canal_manager?useUnicode=true&amp;characterEncoding=UTF-8<br>#canal.manager.jdbc.username=root<br>#canal.manager.jdbc.password=121212<br>canal.id = 1<br>canal.ip =<br>canal.port = 11111<br>canal.metrics.pull.port = 11112<br>canal.zkServers = 192.168.52.146:2181  #ä¿®æ”¹ä¸ºzookeeperé›†ç¾¤çš„åœ°å€,å¯ä»¥å†™lb ä¹Ÿå¯ä»¥æ‰€æœ‰èŠ‚ç‚¹</p><h1 id="flush-data-to-zk"><a href="#flush-data-to-zk" class="headerlink" title="flush data to zk"></a>flush data to zk</h1><p>canal.zookeeper.flush.period = 1000<br>canal.withoutNetty = false</p><h1 id="tcp-kafka-RocketMQ"><a href="#tcp-kafka-RocketMQ" class="headerlink" title="tcp, kafka, RocketMQ"></a>tcp, kafka, RocketMQ</h1><p>canal.serverMode = kafka</p><h1 id="flush-meta-cursor-parse-position-to-file"><a href="#flush-meta-cursor-parse-position-to-file" class="headerlink" title="flush meta cursor/parse position to file"></a>flush meta cursor/parse position to file</h1><p>canal.file.data.dir = ${canal.conf.dir}<br>canal.file.flush.period = 1000</p><h2 id="memory-store-RingBuffer-size-should-be-Math-pow-2-n"><a href="#memory-store-RingBuffer-size-should-be-Math-pow-2-n" class="headerlink" title="memory store RingBuffer size, should be Math.pow(2,n)"></a>memory store RingBuffer size, should be Math.pow(2,n)</h2><p>canal.instance.memory.buffer.size = 16384</p><h2 id="memory-store-RingBuffer-used-memory-unit-size-default-1kb"><a href="#memory-store-RingBuffer-used-memory-unit-size-default-1kb" class="headerlink" title="memory store RingBuffer used memory unit size , default 1kb"></a>memory store RingBuffer used memory unit size , default 1kb</h2><p>canal.instance.memory.buffer.memunit = 1024 </p><h2 id="meory-store-gets-mode-used-MEMSIZE-or-ITEMSIZE"><a href="#meory-store-gets-mode-used-MEMSIZE-or-ITEMSIZE" class="headerlink" title="meory store gets mode used MEMSIZE or ITEMSIZE"></a>meory store gets mode used MEMSIZE or ITEMSIZE</h2><p>canal.instance.memory.batch.mode = MEMSIZE<br>canal.instance.memory.rawEntry = true</p><h2 id="detecing-config"><a href="#detecing-config" class="headerlink" title="detecing config"></a>detecing config</h2><p>canal.instance.detecting.enable = false<br>#canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()<br>canal.instance.detecting.sql = select 1<br>canal.instance.detecting.interval.time = 3<br>canal.instance.detecting.retry.threshold = 3<br>canal.instance.detecting.heartbeatHaEnable = false</p><h1 id="support-maximum-transaction-size-more-than-the-size-of-the-transaction-will-be-cut-into-multiple-transactions-delivery"><a href="#support-maximum-transaction-size-more-than-the-size-of-the-transaction-will-be-cut-into-multiple-transactions-delivery" class="headerlink" title="support maximum transaction size, more than the size of the transaction will be cut into multiple transactions delivery"></a>support maximum transaction size, more than the size of the transaction will be cut into multiple transactions delivery</h1><p>canal.instance.transaction.size =  1024</p><h1 id="mysql-fallback-connected-to-new-master-should-fallback-times"><a href="#mysql-fallback-connected-to-new-master-should-fallback-times" class="headerlink" title="mysql fallback connected to new master should fallback times"></a>mysql fallback connected to new master should fallback times</h1><p>canal.instance.fallbackIntervalInSeconds = 60</p><h1 id="network-config"><a href="#network-config" class="headerlink" title="network config"></a>network config</h1><p>canal.instance.network.receiveBufferSize = 16384<br>canal.instance.network.sendBufferSize = 16384<br>canal.instance.network.soTimeout = 30</p><h1 id="binlog-filter-config"><a href="#binlog-filter-config" class="headerlink" title="binlog filter config"></a>binlog filter config</h1><p>canal.instance.filter.druid.ddl = true<br>canal.instance.filter.query.dcl = false<br>canal.instance.filter.query.dml = false<br>canal.instance.filter.query.ddl = false<br>canal.instance.filter.table.error = false<br>canal.instance.filter.rows = false<br>canal.instance.filter.transaction.entry = false</p><h1 id="binlog-format-image-check"><a href="#binlog-format-image-check" class="headerlink" title="binlog format/image check"></a>binlog format/image check</h1><p>canal.instance.binlog.format = ROW,STATEMENT,MIXED<br>canal.instance.binlog.image = FULL,MINIMAL,NOBLOB</p><h1 id="binlog-ddl-isolation"><a href="#binlog-ddl-isolation" class="headerlink" title="binlog ddl isolation"></a>binlog ddl isolation</h1><p>canal.instance.get.ddl.isolation = false</p><h1 id="parallel-parser-config"><a href="#parallel-parser-config" class="headerlink" title="parallel parser config"></a>parallel parser config</h1><p>canal.instance.parser.parallel = true</p><h2 id="concurrent-thread-number-default-60-available-processors-suggest-not-to-exceed-Runtime-getRuntime-availableProcessors"><a href="#concurrent-thread-number-default-60-available-processors-suggest-not-to-exceed-Runtime-getRuntime-availableProcessors" class="headerlink" title="concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()"></a>concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()</h2><p>#canal.instance.parser.parallelThreadSize = 16</p><h2 id="disruptor-ringbuffer-size-must-be-power-of-2"><a href="#disruptor-ringbuffer-size-must-be-power-of-2" class="headerlink" title="disruptor ringbuffer size, must be power of 2"></a>disruptor ringbuffer size, must be power of 2</h2><p>canal.instance.parser.parallelBufferSize = 256</p><h1 id="table-meta-tsdb-info"><a href="#table-meta-tsdb-info" class="headerlink" title="table meta tsdb info"></a>table meta tsdb info</h1><p>canal.instance.tsdb.enable = true<br>canal.instance.tsdb.dir = ${canal.file.data.dir:../conf}/${canal.instance.destination:}<br>canal.instance.tsdb.url = jdbc:h2:${canal.instance.tsdb.dir}/h2;CACHE_SIZE=1000;MODE=MYSQL;<br>canal.instance.tsdb.dbUsername = canal<br>canal.instance.tsdb.dbPassword = canal</p><h1 id="dump-snapshot-interval-default-24-hour"><a href="#dump-snapshot-interval-default-24-hour" class="headerlink" title="dump snapshot interval, default 24 hour"></a>dump snapshot interval, default 24 hour</h1><p>canal.instance.tsdb.snapshot.interval = 24</p><h1 id="purge-snapshot-expire-default-360-hour-15-days"><a href="#purge-snapshot-expire-default-360-hour-15-days" class="headerlink" title="purge snapshot expire , default 360 hour(15 days)"></a>purge snapshot expire , default 360 hour(15 days)</h1><p>canal.instance.tsdb.snapshot.expire = 360</p><h1 id="aliyun-ak-sk-support-rds-mq"><a href="#aliyun-ak-sk-support-rds-mq" class="headerlink" title="aliyun ak/sk , support rds/mq"></a>aliyun ak/sk , support rds/mq</h1><p>canal.aliyun.accessKey =<br>canal.aliyun.secretKey =</p><p>#################################################<br>#########               destinations            #############<br>#################################################<br>canal.destinations = example</p><h1 id="conf-root-dir"><a href="#conf-root-dir" class="headerlink" title="conf root dir"></a>conf root dir</h1><p>canal.conf.dir = ../conf</p><h1 id="auto-scan-instance-dir-add-remove-and-start-stop-instance"><a href="#auto-scan-instance-dir-add-remove-and-start-stop-instance" class="headerlink" title="auto scan instance dir add/remove and start/stop instance"></a>auto scan instance dir add/remove and start/stop instance</h1><p>canal.auto.scan = true<br>canal.auto.scan.interval = 5</p><p>canal.instance.tsdb.spring.xml = classpath:spring/tsdb/h2-tsdb.xml<br>#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/mysql-tsdb.xml</p><p>canal.instance.global.mode = spring<br>canal.instance.global.lazy = false<br>#canal.instance.global.manager.address = 127.0.0.1:1099<br>#canal.instance.global.spring.xml = classpath:spring/memory-instance.xml<br>canal.instance.global.spring.xml = classpath:spring/file-instance.xml<br>#canal.instance.global.spring.xml = classpath:spring/default-instance.xml</p><p>##################################################<br>#########                    MQ                      #############<br>##################################################<br>canal.mq.servers = 192.168.52.146:9092 #ä¿®æ”¹ä¸ºkafkaé›†ç¾¤çš„åœ°å€,å¯ä»¥å†™lb ä¹Ÿå¯ä»¥æ‰€æœ‰èŠ‚ç‚¹<br>canal.mq.retries = 0<br>canal.mq.batchSize = 16384<br>canal.mq.maxRequestSize = 1048576<br>canal.mq.lingerMs = 100<br>canal.mq.bufferMemory = 33554432<br>canal.mq.canalBatchSize = 50<br>canal.mq.canalGetTimeout = 100<br>canal.mq.flatMessage = true<br>canal.mq.compressionType = none<br>canal.mq.acks = all</p><h1 id="use-transaction-for-kafka-flatMessage-batch-produce"><a href="#use-transaction-for-kafka-flatMessage-batch-produce" class="headerlink" title="use transaction for kafka flatMessage batch produce"></a>use transaction for kafka flatMessage batch produce</h1><p>canal.mq.transaction = false<br>#canal.mq.properties. =</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- å…³äºmq é…ç½®2</span><br></pre></td></tr></table></figure><p>canalæ˜¯ä½¿ç”¨zookeeperæ¥ä¿è¯HAçš„<br>å…³äºHA è§å®˜ç½‘è¯´æ˜ â€œHAæœºåˆ¶è®¾è®¡â€éƒ¨åˆ† <a href="https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener">https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B</a></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## å¯åŠ¨</span><br><span class="line"></span><br><span class="line">- å¯åŠ¨ç¬¬ä¸€å°æœºå™¨ canal02</span><br></pre></td></tr></table></figure><p>/usr/local/canal/bin/startup.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- æŸ¥çœ‹æ—¥å¿—</span><br></pre></td></tr></table></figure><p>OpenJDK 64-Bit Server VM warning: ignoring option PermSize=96m; support was removed in 8.0</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- zookeeperçŠ¶æ€</span><br></pre></td></tr></table></figure><p>[zk: localhost:2181(CONNECTED) 2] ls /otter/canal/cluster<br>[10.31.150.42:11111]<br>[zk: localhost:2181(CONNECTED) 3] get /otter/canal/destinations/example/running<br>{â€œactiveâ€:true,â€addressâ€:â€10.31.150.42:11111â€,â€cidâ€:1}</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  </span><br><span class="line">- kafkaçŠ¶æ€</span><br></pre></td></tr></table></figure><p>$ /data01/server/kafka/bin/kafka-run-class.sh kafka.tools.GetOffsetShell â€“broker-list 192.168.52.146:9092 â€“topic test â€“time -1<br>test:0:98791<br>test:1:2689<br>test:2:2727<br>test:3:2831<br>test:4:2740<br>test:5:2464<br>test:6:2782<br>test:7:2846<br>test:8:3229<br>test:9:3183<br>test:10:2698<br>test:11:2801<br>test:12:3252<br>test:13:2347<br>test:14:2990</p></li></ul><p>æ¯ä¸ªåˆ†åŒºéƒ½äº§ç”Ÿäº†æ•°æ®</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  </span><br><span class="line">-  å¯åŠ¨ç¬¬äºŒå°æœºå™¨ canal01</span><br></pre></td></tr></table></figure><p>/usr/local/canal/bin/startup.sh</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- æŸ¥çœ‹æ—¥å¿—</span><br></pre></td></tr></table></figure><p> [root@offline-gateway-canal-01 canal]# cat logs/canal/canal.log<br>  OpenJDK 64-Bit Server VM warning: ignoring option PermSize=96m; support was removed in 8.0<br>  OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=256m; support was removed in 8.0<br>  OpenJDK 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed in a future release.<br>  2019-07-18 16:00:29.563 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## set default uncaught exception handler<br>  2019-07-18 16:00:29.601 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## load canal configurations<br>  2019-07-18 16:00:29.608 [main] INFO  c.a.o.c.d.monitor.remote.RemoteConfigLoaderFactory - ## load local canal configurations<br>  2019-07-18 16:00:29.622 [main] INFO  com.alibaba.otter.canal.deployer.CanalStater - ## start the canal server.<br>  2019-07-18 16:00:29.789 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - ## start the canal server[10.31.150.42:11111]<br>  2019-07-18 16:00:30.433 [main] WARN  o.s.beans.GenericTypeAwarePropertyDescriptor - Invalid JavaBean property â€˜connectionCharsetâ€™ being accessed! Ambiguous write methods found next to actually used [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.nio.charset.Charset)]: [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.lang.String)]<br>  2019-07-18 16:00:30.655 [main] ERROR com.alibaba.druid.pool.DruidDataSource - testWhileIdle is true, validationQuery not set<br>  2019-07-18 16:00:30.892 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - â€“&gt; init table filter : ^.<em>..</em>$<br>  2019-07-18 16:00:30.892 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - â€“&gt; init table black filter :<br>  2019-07-18 16:00:30.899 [main] INFO  com.alibaba.otter.canal.deployer.CanalStater - ## the canal server is running now â€¦â€¦<br>  2019-07-18 16:00:30.906 [destination = metrics , address = null , EventParser] ERROR c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - parse events has an error<br>  com.alibaba.otter.canal.parse.exception.CanalParseException: illegal connection is null<br>  2019-07-18 16:00:30.979 [canal-instance-scan-0] INFO  c.a.o.canal.deployer.monitor.SpringInstanceConfigMonitor - auto notify stop metrics successful.</p>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- zookeeperçŠ¶æ€</span><br></pre></td></tr></table></figure><p>  [zk: localhost:2181(CONNECTED) 2] ls /otter/canal/cluster<br>  [10.31.150.42:11111, 10.80.81.39:11111]<br>  [zk: localhost:2181(CONNECTED) 3] get /otter/canal/destinations/example/running<br>  {â€œactiveâ€:true,â€addressâ€:â€10.80.81.39:11111â€,â€cidâ€:1}</p><pre><code></code></pre></li></ul><h1 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h1><p>â€‹    å¯åŠ¨ç¬¬ä¸€å°æ—¶å¼€å§‹è®¢é˜…binlogå¹¶å®æ—¶è¾“å‡ºåˆ°kafka,å¹¶å°†ä¿¡æ¯æ³¨å†Œåˆ°zk</p><p>â€‹    å¯åŠ¨ç¬¬äºŒèƒæ—¶ç¬¬äºŒå°ä»zkè·å–åˆ°exampleå·²ç»è¢«æ³¨å†Œ,æ‰€ä»¥ç­‰å¾…ä¸‹æ¬¡å†æŸ¥è¯¢çŠ¶æ€</p><p>â€‹    ç¬¬ä¸€å°stopä¹‹å,ç¬¬äºŒå°ä»zkæ£€æŸ¥åˆ°exampleæ²¡æœ‰è¢«æ³¨å†Œ,æ‰€ä»¥ä¸Šä»»å¼€å§‹è®¢é˜…binlogå¹¶è¾“å‡ºåˆ°kafka,å¹¶å°†ä¿¡æ¯æ³¨å†Œåˆ°zk</p>]]></content>
      
      
      <categories>
          
          <category> canal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> canal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¿«é€Ÿåˆ é™¤å•ç›®å½•ä¸‹å¤§é‡ç¢æ–‡ä»¶</title>
      <link href="/shell/quickly-delete-lot-files/"/>
      <url>/shell/quickly-delete-lot-files/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼˜ç”±"><a href="#ç¼˜ç”±" class="headerlink" title="ç¼˜ç”±"></a>ç¼˜ç”±</h2><p>ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨åˆ°äº†é˜¿é‡Œäº‘çš„NASæœåŠ¡,æœ‰å¤§é‡ç¢æ–‡ä»¶å­˜å‚¨åˆ°äº†NASä¸­</p><p>åæ¥NASæ”¶è´¹å¤ªè´µ,å°†å†å²æ•°æ®è¿ç§»åˆ°äº†OSSä¸­</p><p>ç°åœ¨éœ€è¦åˆ é™¤NASä¸­çš„ç¢æ–‡ä»¶</p><p>å¤§çº¦150T,30äº¿ä¸ªæ–‡ä»¶</p><h2 id="åˆ é™¤è¿‡ç¨‹"><a href="#åˆ é™¤è¿‡ç¨‹" class="headerlink" title="åˆ é™¤è¿‡ç¨‹"></a>åˆ é™¤è¿‡ç¨‹</h2><h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shutil.rmtree(/nas/data/<span class="number">2019</span><span class="number">-01</span><span class="number">-01</span>/)</span><br></pre></td></tr></table></figure><h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rsync -a --delete /opt/empty/ /nas/data/2019-01-01/</span><br></pre></td></tr></table></figure><h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm -rf &#x2F;nas&#x2F;data&#x2F;2019-01-01&#x2F;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå°è¯•äº†ä»¥ä¸Šä¸‰ç§æ–¹æ³•ï¼Œå‘ç°éå¸¸éå¸¸æ…¢</p><p>é€šè¿‡straceå‘½ä»¤å‘ç°è¿›ç¨‹ä¸»è¦åœ¨åš<strong>getdents</strong>(readdir)æ“ä½œ(è·å–æ–‡ä»¶åˆ—è¡¨)</p><p>å¦å¤–æä¸€å¥å¦‚æœæ˜¯æœ¬åœ°æ•°æ®è¿˜å¥½,é˜¿é‡Œäº‘NASé’ˆå¯¹readdiræ“ä½œåšäº†éƒ¨åˆ†é™åˆ¶,å¯¼è‡´è·å–æ–‡ä»¶åˆ—è¡¨å·¨æ…¢Â·Â·Â·</p><p>æ€ä¹ˆå‘ç°çš„å‘¢ï¼Ÿ</p><p>æˆ‘å¯åŠ¨äº†20ä¸ªçº¿ç¨‹å»è·å–20ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨,å‘ç°æœºå™¨ä¸NASä¹‹é—´çš„æµé‡åªèƒ½åˆ°30Mb,åæ¥åˆå¯åŠ¨äº†40ä¸ªçº¿ç¨‹ä¹Ÿæ˜¯åˆ°30Mb,ç„¶åè·Ÿé˜¿é‡Œäº‘æ²Ÿé€šåä»–ä»¬éœ€è¦å•ç‹¬è°ƒæ•´å‚æ•°æ‰èƒ½ä¼˜åŒ–è¯»å–æ“ä½œ,å› ä¸ºè°ƒæ•´éœ€è¦reload nasæœåŠ¡,å¯¹çº¿ä¸Šæœ‰å½±å“,æˆ‘å°±æ”¾å¼ƒäº†æ²¡è®©ä»–ä»¬åšÂ·Â·Â·</p><h2 id="å†…æ ¸å‚æ•°è°ƒä¼˜"><a href="#å†…æ ¸å‚æ•°è°ƒä¼˜" class="headerlink" title="å†…æ ¸å‚æ•°è°ƒä¼˜"></a>å†…æ ¸å‚æ•°è°ƒä¼˜</h2><p>å› ä¸ºé˜¿é‡Œäº‘NASæœ€ç»ˆæ˜¯ä»¥NFSçš„æ–¹å¼æä¾›æœåŠ¡</p><p>æ‰€ä»¥å®˜æ–¹å»ºè®®è°ƒæ•´OS kernelçš„é™åˆ¶</p><h3 id="Kernel-2-6-Centos6-å·¦å³çš„å†…æ ¸é™åˆ¶ä¸º128"><a href="#Kernel-2-6-Centos6-å·¦å³çš„å†…æ ¸é™åˆ¶ä¸º128" class="headerlink" title="Kernel 2.6(Centos6)å·¦å³çš„å†…æ ¸é™åˆ¶ä¸º128"></a>Kernel 2.6(Centos6)å·¦å³çš„å†…æ ¸é™åˆ¶ä¸º128</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;options sunrpc tcp_slot_table_entries&#x3D;128&quot; &gt;&gt; &#x2F;etc&#x2F;modprobe.d&#x2F;sunrpc.conf</span><br><span class="line">echo &quot;options sunrpc tcp_max_slot_table_entries&#x3D;128&quot; &gt;&gt;  &#x2F;etc&#x2F;modprobe.d&#x2F;sunrpc.conf</span><br><span class="line">sysctl -w sunrpc.tcp_slot_table_entries&#x3D;128</span><br></pre></td></tr></table></figure><h3 id="Kernel-3-Centos7-çš„å†…æ ¸é™åˆ¶ä¸º65535"><a href="#Kernel-3-Centos7-çš„å†…æ ¸é™åˆ¶ä¸º65535" class="headerlink" title="Kernel 3(Centos7)çš„å†…æ ¸é™åˆ¶ä¸º65535"></a>Kernel 3(Centos7)çš„å†…æ ¸é™åˆ¶ä¸º65535</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;options sunrpc tcp_slot_table_entries&#x3D;65535&quot; &gt;&gt; &#x2F;etc&#x2F;modprobe.d&#x2F;sunrpc.conf</span><br><span class="line">echo &quot;options sunrpc tcp_max_slot_table_entries&#x3D;65535&quot; &gt;&gt;  &#x2F;etc&#x2F;modprobe.d&#x2F;sunrpc.conf</span><br><span class="line">sysctl -w sunrpc.tcp_slot_table_entries&#x3D;65535</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‚æ•°åéœ€è¦<strong>é‡æ–°æŒ‚è½½</strong>NASæˆ–è€…<strong>é‡å¯ç³»ç»Ÿ</strong></p><p>å…·ä½“è¯´æ˜è§<a href="https://help.aliyun.com/knowledge_detail/53839.html?spm=a2c4g.11186631.2.16.4218622fLlHtQZ" target="_blank" rel="noopener">é˜¿é‡Œäº‘æ–‡æ¡£</a></p><h2 id="æœ€ä½³æ–¹æ¡ˆ"><a href="#æœ€ä½³æ–¹æ¡ˆ" class="headerlink" title="æœ€ä½³æ–¹æ¡ˆ"></a>æœ€ä½³æ–¹æ¡ˆ</h2><h3 id="å…ˆè·å–æ–‡ä»¶åˆ—è¡¨åå¹¶å‘åˆ é™¤"><a href="#å…ˆè·å–æ–‡ä»¶åˆ—è¡¨åå¹¶å‘åˆ é™¤" class="headerlink" title="å…ˆè·å–æ–‡ä»¶åˆ—è¡¨åå¹¶å‘åˆ é™¤"></a>å…ˆè·å–æ–‡ä»¶åˆ—è¡¨åå¹¶å‘åˆ é™¤</h3><h4 id="1-è·å–æ–‡ä»¶åˆ—è¡¨"><a href="#1-è·å–æ–‡ä»¶åˆ—è¡¨" class="headerlink" title="1. è·å–æ–‡ä»¶åˆ—è¡¨"></a>1. è·å–æ–‡ä»¶åˆ—è¡¨</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -1 -f DIR</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦åŠ åé¢çš„ä¸¤ä¸ªå‚æ•°ï¼Ÿ</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œâ€œ <strong>ls</strong> â€å‘½ä»¤å°†å¯¹å…¶è¾“å‡ºè¿›è¡Œæ’åºã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå®ƒå¿…é¡»é¦–å…ˆå°†æ¯ä¸ªæ–‡ä»¶çš„åç§°ç¯¡æ”¹åˆ°å†…å­˜ä¸­ã€‚é¢å¯¹ä¸€ä¸ªéå¸¸å¤§çš„ç›®å½•ï¼Œå®ƒå°†ååœ¨é‚£é‡Œï¼Œè¯»å–æ–‡ä»¶åï¼Œå ç”¨è¶Šæ¥è¶Šå¤šçš„å†…å­˜ï¼Œç›´åˆ°æœ€ç»ˆæŒ‰å­—æ¯æ•°å­—é¡ºåºä¸€æ¬¡åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ã€‚</p><p>è€Œ<strong>ls -1 -f</strong> åˆ™ä¸æ‰§è¡Œä»»ä½•æ’åºã€‚å®ƒåªæ˜¯è¯»å–ç›®å½•å¹¶ç«‹å³æ˜¾ç¤ºæ–‡ä»¶ã€‚</p><p>å…·ä½“æµ‹è¯•æ–‡æ¡£è¯·å‚è€ƒ<a href="[http://unixetc.co.uk/2012/05/20/large-directory-causes-ls-to-hang/](http://unixetc.co.uk/2012/05/20/large-directory-causes-ls-to-hang/)">å¤§ç¥æ–‡æ¡£</a></p><h4 id="2-åˆ‡åˆ†æ–‡ä»¶"><a href="#2-åˆ‡åˆ†æ–‡ä»¶" class="headerlink" title="2.åˆ‡åˆ†æ–‡ä»¶"></a>2.åˆ‡åˆ†æ–‡ä»¶</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">split -l 10000000 -d list split-tmp-</span><br><span class="line"><span class="meta">#</span><span class="bash"> 100wè¡Œä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ–‡ä»¶åä»¥<span class="string">"split-tmp-"</span>å¼€å¤´</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ–‡ä»¶åä»¥æ•°å­—ç»“å°¾</span></span><br></pre></td></tr></table></figure><h4 id="3-å¹¶å‘åˆ é™¤"><a href="#3-å¹¶å‘åˆ é™¤" class="headerlink" title="3.å¹¶å‘åˆ é™¤"></a>3.å¹¶å‘åˆ é™¤</h4><p><strong>shell å®ç°è¿›ç¨‹å¹¶å‘æ§åˆ¶</strong></p><p>å…³äºshellçš„å¤šè¿›ç¨‹å¹¶å‘è§<a href="https://bbs.51cto.com/thread-1104907-1-1.html" target="_blank" rel="noopener">å¤§ç¥æ–‡æ¡£</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å®šä¹‰æ—¥å¿—</span></span><br><span class="line">Log=./rm.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŒ‡å®šå¹¶å‘æ•°é‡</span></span><br><span class="line">Nproc=20</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æ¥å—ä¿¡å·2 ï¼ˆctrl +C)åšçš„æ“ä½œ</span></span><br><span class="line">trap "exec 1000&gt;$-;exec 1000&lt;&amp;-;exit 0" 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">$$æ˜¯è¿›ç¨‹pid</span></span><br><span class="line">Pfifo="/tmp/$$.fifo"</span><br><span class="line">mkfifo $Pfifo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ä»¥1000ä¸ºæ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ç®¡é“,&lt;&gt;è¡¨ç¤ºå¯è¯»å¯å†™</span></span><br><span class="line">exec 1000&lt;&gt;$Pfifo</span><br><span class="line">rm -f $Pfifo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å‘ç®¡é“ä¸­å†™å…¥Nprocè¡Œ,ä½œä¸ºä»¤ç‰Œ</span></span><br><span class="line">for((i=1; i&lt;=$Nproc; i++)); do</span><br><span class="line">    echo</span><br><span class="line">done &gt;&amp;1000</span><br><span class="line"></span><br><span class="line">filenames=`ls split-tmp-*`</span><br><span class="line">for filename in $filenames; do</span><br><span class="line"><span class="meta">#</span><span class="bash">ä»ç®¡é“ä¸­å–å‡º1è¡Œä½œä¸ºtokenï¼Œå¦‚æœç®¡é“ä¸ºç©ºï¼Œ<span class="built_in">read</span>å°†ä¼šé˜»å¡</span></span><br><span class="line"><span class="meta">#</span><span class="bash">man bashå¯ä»¥çŸ¥é“-uæ˜¯ä»fdä¸­è¯»å–ä¸€è¡Œ</span></span><br><span class="line">    read -u1000</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">    #æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡</span><br><span class="line">        DirPrefix=/nas/data</span><br><span class="line">        while read line;do</span><br><span class="line">            rm -I $DirPrefix/$line || echo "`date +%F-%T` rm -rf $DirPrefix/$line failed" | tee &gt;&gt; $Log</span><br><span class="line">        done &lt; $filename  &amp;&amp; &#123;</span><br><span class="line">            echo "`date +%F-%T` $filename done" | tee &gt;&gt; $Log</span><br><span class="line">        &#125; || &#123;</span><br><span class="line">            echo "`date +%F-%T` $filename error" | tee &gt;&gt; $Log</span><br><span class="line">        &#125;</span><br><span class="line">        sleep 5</span><br><span class="line">    #å½’è¿˜token</span><br><span class="line">        echo &gt;&amp;1000</span><br><span class="line">    &#125;&amp;</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">wait </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å…³é—­ç®¡é“</span></span><br><span class="line">exec 1000&gt;&amp;-</span><br><span class="line">exec 1000&lt;&amp;-</span><br></pre></td></tr></table></figure><h2 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h2><p>å»ºè®®æ–‡ä»¶é‡ç‰¹åˆ«å¤šæ—¶åˆ†å¼€ç›®å½•å­˜å‚¨,ä¸ç„¶åç»­å¤„ç†ä¼šå¾ˆæ£˜æ‰‹</p><p>ä»£ç å¤šå†™ä¸€ç‚¹,ä¸ºåæ¥äººå¤šè€ƒè™‘ä¸€ç‚¹</p><h3 id="æ ¼å¼"><a href="#æ ¼å¼" class="headerlink" title="æ ¼å¼"></a>æ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data&#x2F;å¹´-æœˆ-æ—¥&#x2F;[0-1023]&#x2F;file</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹è¿™ç§æƒ…å†µ,å•ä¸ªç›®å½•ä¸‹å¯èƒ½åªæœ‰ä¸€ä¸¤ä¸‡ä¸ªæ–‡ä»¶</p><p>å¯ä»¥ç”¨pythonå¹¶å‘åˆ é™¤</p><p>å®æµ‹: æ¯åˆ†é’Ÿåˆ é™¤NASé‡Œ2.6wä¸ªæ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">target_path = <span class="string">"/data/"</span></span><br><span class="line"></span><br><span class="line">pathnames = os.listdir(target_path)</span><br><span class="line">today = datetime.datetime.now()</span><br><span class="line">month_ago = today + datetime.timedelta(days=<span class="number">-30</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dirdel</span><span class="params">(tpath)</span>:</span></span><br><span class="line">    t1 = time.time()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start delete:"</span>,tpath</span><br><span class="line">    shutil.rmtree(tpath)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"deleted: %s in %s"</span>%(tpath,time.time()-t1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> date_path <span class="keyword">in</span> pathnames:</span><br><span class="line">    tmp_path = target_path+date_path</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(tmp_path):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> (datetime.datetime.strptime(date_path, <span class="string">"%Y-%m-%d"</span>)&lt;month_ago):</span><br><span class="line">        print(tmp_path)</span><br><span class="line">        <span class="keyword">while</span> len(threading.enumerate())&gt;<span class="number">40</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"waiting..."</span></span><br><span class="line">            time.sleep(<span class="number">30</span>)</span><br><span class="line">        threading.Thread(target=dirdel, args=(tmp_path,)).start()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>filebeat-é™åˆ¶CPUä½¿ç”¨</title>
      <link href="/efk/filebeat/limit-cpu/"/>
      <url>/efk/filebeat/limit-cpu/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼˜ç”±"><a href="#ç¼˜ç”±" class="headerlink" title="ç¼˜ç”±"></a>ç¼˜ç”±</h2><p>æ—¥å¿—é‡å¤§çš„æ—¶æ—¶å€™filebeatä¼šå ç”¨éå¸¸é«˜çš„CPU,ä¸ºäº†é˜²æ­¢å½±å“ä¸šåŠ¡ç¨³å®š,å†³å®šå¯¹filebeatçš„CPUè¿›è¡Œé™åˆ¶æ ¸æ•°</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><h3 id="é™åˆ¶ä½¿ç”¨çš„cpuæ ¸æ•°"><a href="#é™åˆ¶ä½¿ç”¨çš„cpuæ ¸æ•°" class="headerlink" title="é™åˆ¶ä½¿ç”¨çš„cpuæ ¸æ•°"></a>é™åˆ¶ä½¿ç”¨çš„cpuæ ¸æ•°</h3><p>â€‹    filebeat.ymlæ–‡ä»¶ä¸­å¯ä»¥æŒ‡å®šâ€max_procsâ€å‚æ•°</p><p>â€‹    max_procs: é™åˆ¶filebeatçš„è¿›ç¨‹æ•°é‡,å…¶å®å°±æ˜¯å†…æ ¸æ•°</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">max_procs: 1</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  #include_lines: [&quot;^\\[[0-9]&#123;4&#125;&quot;]</span><br><span class="line">  tail_files: true</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;var&#x2F;log&#x2F;*.log</span><br><span class="line">  fields:</span><br><span class="line">    device: pudding1s</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  document_type: log</span><br></pre></td></tr></table></figure><h3 id="é™ä½filebeatè¿›ç¨‹ä¼˜å…ˆçº§"><a href="#é™ä½filebeatè¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="é™ä½filebeatè¿›ç¨‹ä¼˜å…ˆçº§"></a>é™ä½filebeatè¿›ç¨‹ä¼˜å…ˆçº§</h3><h4 id="å¯åŠ¨æ—¶æŒ‡å®šè¿›ç¨‹ä¼˜å…ˆçº§"><a href="#å¯åŠ¨æ—¶æŒ‡å®šè¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="å¯åŠ¨æ—¶æŒ‡å®šè¿›ç¨‹ä¼˜å…ˆçº§"></a>å¯åŠ¨æ—¶æŒ‡å®šè¿›ç¨‹ä¼˜å…ˆçº§</h4><p>â€‹    ä½¿ç”¨niceå‘½ä»¤</p><p>â€‹    ä½¿ç”¨æ–¹æ³•: nice -n å‘½ä»¤</p><p>â€‹    ä¼˜å…ˆçº§ç”± -20~19è¿™ä¸ªèŒƒå›´æ¥è¡¨ç¤ºä¼˜å…ˆçº§å¤§å°ï¼Œæ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜(é»˜è®¤0)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/init.d/filebeat </span></span><br><span class="line">Â·Â·Â·</span><br><span class="line">start() &#123; </span><br><span class="line">    [ -x $filebeat ] || exit 5 </span><br><span class="line">    [ -f $FILEBEAT_CONF_FILE ] || exit 6 </span><br><span class="line">    echo -n $"Starting $prog: " </span><br><span class="line">    #daemon $filebeat -c $FILEBEAT_CONF_FILE </span><br><span class="line">    nice -n 10 nohup $filebeat -c $FILEBEAT_CONF_FILE &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">    retval=$? </span><br><span class="line">    echo </span><br><span class="line">    [ $retval -eq 0 ] &amp;&amp; touch $lockfile </span><br><span class="line">    return $retval </span><br><span class="line">&#125; </span><br><span class="line">Â·Â·Â·</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨åæ‰‹åŠ¨è°ƒæ•´è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#å¯åŠ¨åæ‰‹åŠ¨è°ƒæ•´è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="å¯åŠ¨åæ‰‹åŠ¨è°ƒæ•´è¿›ç¨‹ä¼˜å…ˆçº§"></a>å¯åŠ¨åæ‰‹åŠ¨è°ƒæ•´è¿›ç¨‹ä¼˜å…ˆçº§</h4><p>â€‹    ä½¿ç”¨renice å‘½ä»¤</p><p>â€‹    ä½¿ç”¨æ–¹æ³•: renice ä¼˜å…ˆçº§  è¿›ç¨‹PID</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FilebeatPid&#x3D;&#96;ps -ef |grep filebeat |grep -v grep |awk &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">renice 10 $FilebeatPid</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> EFK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EFK </tag>
            
            <tag> filebeat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>filebeat-é‡æ–°æ”¶å–æŸä¸ªæ—¥å¿—æ–‡ä»¶</title>
      <link href="/efk/filebeat/reload-log/"/>
      <url>/efk/filebeat/reload-log/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼˜ç”±"><a href="#ç¼˜ç”±" class="headerlink" title="ç¼˜ç”±"></a>ç¼˜ç”±</h2><p>filebeatæƒ³é‡æ–°æ”¶å–æŸä¸ªæ–‡ä»¶,æˆ–è€…ä»æŒ‡å®šä½ç½®é‡æ–°æ”¶å–æŸä¸ªæ–‡ä»¶</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><h3 id="å…¨éƒ¨é‡æ–°æ”¶å–"><a href="#å…¨éƒ¨é‡æ–°æ”¶å–" class="headerlink" title="å…¨éƒ¨é‡æ–°æ”¶å–"></a>å…¨éƒ¨é‡æ–°æ”¶å–</h3><p>â€‹    åˆ é™¤registryæ–‡ä»¶å¹¶é‡å¯filebeat</p><p>â€‹    PS: è¿™ç§æ–¹æ³•ä¼šå°†æ‰€æœ‰æ–‡ä»¶é‡æ–°æ”¶å–</p><h3 id="é‡æ–°æ”¶å–å•ä¸ªæ–‡ä»¶"><a href="#é‡æ–°æ”¶å–å•ä¸ªæ–‡ä»¶" class="headerlink" title="é‡æ–°æ”¶å–å•ä¸ªæ–‡ä»¶"></a>é‡æ–°æ”¶å–å•ä¸ªæ–‡ä»¶</h3><p>â€‹    ä¿®æ”¹registryæ–‡ä»¶ä¸­å¯¹åº”æ–‡ä»¶çš„offsetä¿¡æ¯å¹¶é‡å¯filebeat</p><p>â€‹    PS: å…³äºregistryæ–‡ä»¶çš„æ ¼å¼å‚è§â€<a href="https://blog.opsolo.com/efk/filebeat/filebeat-registryæ–‡ä»¶å†…å®¹è§£æ" target="_blank" rel="noopener">registryæ–‡ä»¶å†…å®¹è§£æ</a>â€œ</p><p>â€‹    offsetä¿®æ”¹ä¸º0åˆ™ä»£è¡¨ä»å¤´å¼€å§‹,æˆ–è€…æŒ‡å®šoffsetä»æŒ‡å®šä½ç½®æ”¶å–</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="attr">"source"</span>:<span class="string">"/var/log/php/laravel-2019-05-19.log"</span>,</span><br><span class="line">    <span class="attr">"offset"</span>:<span class="number">1632</span>,</span><br><span class="line">    <span class="attr">"FileStateOS"</span>:&#123;</span><br><span class="line">        <span class="attr">"inode"</span>:<span class="number">4353086</span>,</span><br><span class="line">        <span class="attr">"device"</span>:<span class="number">64529</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"timestamp"</span>:<span class="string">"2019-05-19T12:35:34.724025571+08:00"</span>,</span><br><span class="line">    <span class="attr">"ttl"</span>:<span class="number">-1</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> EFK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EFK </tag>
            
            <tag> filebeat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>filebeat-registryæ–‡ä»¶å†…å®¹è§£æ</title>
      <link href="/efk/filebeat/registry-content-analysis/"/>
      <url>/efk/filebeat/registry-content-analysis/</url>
      
        <content type="html"><![CDATA[<h2 id="filebeatä¸­registryæ–‡ä»¶çš„ä½œç”¨"><a href="#filebeatä¸­registryæ–‡ä»¶çš„ä½œç”¨" class="headerlink" title="filebeatä¸­registryæ–‡ä»¶çš„ä½œç”¨"></a>filebeatä¸­registryæ–‡ä»¶çš„ä½œç”¨</h2><p>registryæ–‡ä»¶ä¸­å­˜æ”¾çš„è¢«é‡‡é›†çš„æ‰€æœ‰æ—¥å¿—æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯</p><h2 id="æ–‡ä»¶å†…å®¹è§£æ"><a href="#æ–‡ä»¶å†…å®¹è§£æ" class="headerlink" title="æ–‡ä»¶å†…å®¹è§£æ"></a>æ–‡ä»¶å†…å®¹è§£æ</h2><h3 id="å†…å®¹æ ·ä¾‹"><a href="#å†…å®¹æ ·ä¾‹" class="headerlink" title="å†…å®¹æ ·ä¾‹"></a>å†…å®¹æ ·ä¾‹</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="attr">"source"</span>:<span class="string">"/var/log/php/laravel-2019-05-19.log"</span>,</span><br><span class="line">    <span class="attr">"offset"</span>:<span class="number">1632</span>,</span><br><span class="line">    <span class="attr">"FileStateOS"</span>:&#123;</span><br><span class="line">        <span class="attr">"inode"</span>:<span class="number">4353086</span>,</span><br><span class="line">        <span class="attr">"device"</span>:<span class="number">64529</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"timestamp"</span>:<span class="string">"2019-05-19T12:35:34.724025571+08:00"</span>,</span><br><span class="line">    <span class="attr">"ttl"</span>:<span class="number">-1</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><h3 id="å­—æ®µè¯´æ˜"><a href="#å­—æ®µè¯´æ˜" class="headerlink" title="å­—æ®µè¯´æ˜"></a>å­—æ®µè¯´æ˜</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">source æ—¥å¿—æ–‡ä»¶çš„å®Œæ•´è·¯å¾„</span><br><span class="line">offsetã€€å·²ç»é‡‡é›†åˆ°æ—¥å¿—çš„å“ªä¸ªå­—èŠ‚ä½ç½®</span><br><span class="line">FileStateOSã€€ã€€æ“ä½œç³»ç»Ÿç›¸å…³</span><br><span class="line">ã€€ã€€inodeã€€ã€€   æ—¥å¿—æ–‡ä»¶çš„inodeå·</span><br><span class="line">ã€€ã€€device     æ—¥å¿—æ‰€åœ¨ç£ç›˜çš„ç£ç›˜ç¼–å·</span><br><span class="line">timestampã€€æ—¥å¿—æœ€åä¸€æ¬¡å‘ç”Ÿå˜åŒ–çš„æ—¶é—´æˆ³</span><br><span class="line">ttlã€€ã€€    é‡‡é›†å¤±æ•ˆæ—¶é—´ã€‚(-1è¡¨ç¤ºåªè¦æ—¥å¿—å­˜åœ¨ï¼Œå°±ä¸€ç›´é‡‡é›†è¯¥æ—¥å¿—)</span><br></pre></td></tr></table></figure><h4 id="FileStateOSä¿¡æ¯"><a href="#FileStateOSä¿¡æ¯" class="headerlink" title="FileStateOSä¿¡æ¯"></a>FileStateOSä¿¡æ¯</h4><p>filestatOSå¯ä»¥é€šè¿‡statå‘½ä»¤è·å–</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@test /]# stat /var/log/php/laravel-2019-05-19.log</span><br><span class="line">  File: `/var/log/php/laravel-2019-05-19.log'</span><br><span class="line">  Size: 1632            Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: fc11h/64529d    Inode: 4353086     Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (  500/     www)   Gid: (  500/     www)</span><br><span class="line">Access: 2019-05-19 12:30:27.517385737 +0800</span><br><span class="line">Modify: 2019-05-19 12:30:25.992385735 +0800</span><br><span class="line">Change: 2019-05-19 12:30:25.992385735 +0800</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> EFK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EFK </tag>
            
            <tag> filebeat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo Gitalk è¯„è®ºè‡ªåŠ¨åˆå§‹åŒ–</title>
      <link href="/hexo/hexo-gitalk-auto-init/"/>
      <url>/hexo/hexo-gitalk-auto-init/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åˆ‡æ¢åˆ°Gitalkåæ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨å»åˆ›å»ºissue,ä¸ºäº†ç®€åŒ–æµç¨‹,ä½¿ç”¨Nodejså’ŒGithubAPIå»è‡ªåŠ¨åˆå§‹åŒ–</p><p>å‚è€ƒåŸæ–‡ï¼š<a href="https://daihaoxin.github.io/post/322747ae.html" target="_blank" rel="noopener">daihaoxin</a></p></blockquote><h3 id="ä¸€ã€ç”Ÿæˆsitemapç«™ç‚¹åœ°å›¾"><a href="#ä¸€ã€ç”Ÿæˆsitemapç«™ç‚¹åœ°å›¾" class="headerlink" title="ä¸€ã€ç”Ÿæˆsitemapç«™ç‚¹åœ°å›¾"></a>ä¸€ã€ç”Ÿæˆsitemapç«™ç‚¹åœ°å›¾</h3><h4 id="1-å®‰è£…æ’ä»¶"><a href="#1-å®‰è£…æ’ä»¶" class="headerlink" title="1. å®‰è£…æ’ä»¶"></a>1. å®‰è£…æ’ä»¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br></pre></td></tr></table></figure><h4 id="2-åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„-config-ymlæ·»åŠ å¦‚ä¸‹ä»£ç "><a href="#2-åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„-config-ymlæ·»åŠ å¦‚ä¸‹ä»£ç " class="headerlink" title="2. åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„_config.ymlæ·»åŠ å¦‚ä¸‹ä»£ç "></a>2. åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹çš„_config.ymlæ·»åŠ å¦‚ä¸‹ä»£ç </h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hexo sitemapç½‘ç«™åœ°å›¾</span></span><br><span class="line"><span class="attr">sitemap:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">sitemap.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">baidusitemap:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">baidusitemap.xml</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨åœ¨æ‰§è¡Œ<code>hexo generate</code>çš„æ—¶å€™ï¼Œåœ¨åšå®¢æ ¹ç›®å½•ä¸‹çš„publicæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œå°±ä¼šç”Ÿæˆsitemap.xmlå’Œbaidusitemap.xmlã€‚</p><h3 id="äºŒã€è·å–githubæ¥å£çš„è°ƒç”¨æƒé™"><a href="#äºŒã€è·å–githubæ¥å£çš„è°ƒç”¨æƒé™" class="headerlink" title="äºŒã€è·å–githubæ¥å£çš„è°ƒç”¨æƒé™"></a>äºŒã€è·å–githubæ¥å£çš„è°ƒç”¨æƒé™</h3><ol><li>åˆ›å»ºä¸€ä¸ªaccess token <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">ç‚¹æ­¤è¿›å…¥</a></li><li>ç‚¹å‡»Generate new tokenæŒ‰é’®</li><li>è¾“å…¥ä¸€ä¸ªæè¿°ï¼Œä¸ºtokenæ·»åŠ æ‰€æœ‰çš„<code>repo</code>æƒé™ï¼Œç„¶åç‚¹å‡»æœ€ä¸‹æ–¹çš„<code>Generate token</code>æŒ‰é’®ï¼Œå°±å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„Token</li><li>Tokenåœ¨ä¸‹é¢çš„è„šæœ¬ä¼šç”¨åˆ°</li></ol><h3 id="ä¸‰ã€éƒ¨ç½²è„šæœ¬"><a href="#ä¸‰ã€éƒ¨ç½²è„šæœ¬" class="headerlink" title="ä¸‰ã€éƒ¨ç½²è„šæœ¬"></a>ä¸‰ã€éƒ¨ç½²è„šæœ¬</h3><h4 id="1-å®‰è£…ä¾èµ–åŒ…"><a href="#1-å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="1. å®‰è£…ä¾èµ–åŒ…"></a>1. å®‰è£…ä¾èµ–åŒ…</h4><p>  åœ¨ä½ hexoçš„æ ¹ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install request --save</span><br><span class="line">npm install xml-parser --save</span><br><span class="line">npm install yamljs --save</span><br><span class="line">npm install cheerio --save</span><br><span class="line">npm install md5 --save</span><br></pre></td></tr></table></figure><h4 id="2-åˆ›å»ºè„šæœ¬æ–‡ä»¶"><a href="#2-åˆ›å»ºè„šæœ¬æ–‡ä»¶" class="headerlink" title="2. åˆ›å»ºè„šæœ¬æ–‡ä»¶"></a>2. åˆ›å»ºè„šæœ¬æ–‡ä»¶</h4><p>  åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹åˆ›å»ºcomment.jsæ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„ä»£ç ç²˜è´´è¿›æ–‡ä»¶ä¸­ï¼Œç„¶åä¿®æ”¹configä¸­çš„é…ç½®é¡¹ï¼Œå…¶ä¸­<code>token</code>å°±æ˜¯ä¸Šä¸€æ­¥ä¸­è·å–çš„å€¼</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">"request"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</span><br><span class="line"><span class="keyword">const</span> xmlParser = <span class="built_in">require</span>(<span class="string">"xml-parser"</span>);</span><br><span class="line"><span class="keyword">const</span> YAML = <span class="built_in">require</span>(<span class="string">"yamljs"</span>);</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">"cheerio"</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">"md5"</span>);</span><br><span class="line"><span class="comment">// æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œé…ç½®</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    username: <span class="string">"sungaomeng"</span>, <span class="comment">// GitHub ç”¨æˆ·å</span></span><br><span class="line">    token: <span class="string">"********"</span>,  <span class="comment">// GitHub Token</span></span><br><span class="line">    repo: <span class="string">"sungaomeng.github.io"</span>,  <span class="comment">// å­˜æ”¾ issuesçš„gitä»“åº“</span></span><br><span class="line">    <span class="comment">// sitemap.xmlçš„è·¯å¾„ï¼Œcommit.jsæ”¾ç½®åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæ— éœ€ä¿®æ”¹ï¼Œå…¶ä»–æƒ…å†µè‡ªè¡Œå¤„ç†</span></span><br><span class="line">    sitemapUrl: path.resolve(__dirname, <span class="string">"./public/sitemap.xml"</span>),</span><br><span class="line">    kind: <span class="string">"Gitalk"</span>,  <span class="comment">// "Gitalk" or "Gitment"ï¼Œ</span></span><br><span class="line">    baseUrl: <span class="string">"https://opsolo.com/"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> issuesUrl = <span class="string">`https://api.github.com/repos/<span class="subst">$&#123;config.username&#125;</span>/<span class="subst">$&#123;config.repo&#125;</span>/issues?access_token=<span class="subst">$&#123;config.token&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> requestGetOpt = &#123;</span><br><span class="line">    url: <span class="string">`<span class="subst">$&#123;issuesUrl&#125;</span>&amp;page=1&amp;per_page=1000`</span>,</span><br><span class="line">    json: <span class="literal">true</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"github-user"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> requestPostOpt = &#123;</span><br><span class="line">    ...requestGetOpt,</span><br><span class="line">    url:issuesUrl,</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    form: <span class="string">""</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"å¼€å§‹åˆå§‹åŒ–è¯„è®º..."</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"å¼€å§‹æ£€ç´¢é“¾æ¥ï¼Œè¯·ç¨ç­‰..."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> websiteConfig = YAML.parse(fs.readFileSync(path.resolve(__dirname, <span class="string">"./_config.yml"</span>), <span class="string">"utf8"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> urls = sitemapXmlReader(config.sitemapUrl);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`å…±æ£€ç´¢åˆ°<span class="subst">$&#123;urls.length&#125;</span>ä¸ªé“¾æ¥`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"å¼€å§‹è·å–å·²ç»åˆå§‹åŒ–çš„issues:"</span>);</span><br><span class="line">        <span class="keyword">let</span> issues = <span class="keyword">await</span> send(requestGetOpt);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`å·²ç»å­˜åœ¨<span class="subst">$&#123;issues.length&#125;</span>ä¸ªissues`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> notInitIssueLinks = urls.filter(<span class="function">(<span class="params">link</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> !issues.find(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">                link = removeProtocol(link);</span><br><span class="line">                <span class="keyword">return</span> item.body.includes(link);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (notInitIssueLinks.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`æœ¬æ¬¡æœ‰<span class="subst">$&#123;notInitIssueLinks.length&#125;</span>ä¸ªé“¾æ¥éœ€è¦åˆå§‹åŒ–issueï¼š`</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(notInitIssueLinks);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"å¼€å§‹æäº¤åˆå§‹åŒ–è¯·æ±‚, å¤§çº¦éœ€è¦40ç§’..."</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * éƒ¨ç½²å¥½ç½‘ç«™åï¼Œç›´æ¥æ‰§è¡Œstartï¼Œæ–°å¢æ–‡ç« å¹¶ä¸ä¼šç”Ÿæˆè¯„è®º</span></span><br><span class="line"><span class="comment">             * ç»æµ‹è¯•ï¼Œæœ€å°‘éœ€è¦ç­‰å¾…40ç§’ï¼Œæ‰å¯ä»¥æ­£ç¡®ç”Ÿæˆï¼Œ æ€€ç–‘è·Ÿgithubçš„apiæœ‰å…³ç³»ï¼Œæ²¡æœ‰æ‰¾åˆ°å®é”¤</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            setTimeout(<span class="keyword">async</span> ()=&gt;&#123;</span><br><span class="line">                <span class="keyword">let</span> initRet = <span class="keyword">await</span> notInitIssueLinks.map(<span class="keyword">async</span> (item) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> html = <span class="keyword">await</span> send(&#123; ...requestGetOpt, <span class="attr">url</span>: item &#125;);</span><br><span class="line">                    <span class="keyword">let</span> title = cheerio.load(html)(<span class="string">"title"</span>).text();</span><br><span class="line">                    <span class="keyword">let</span> pathLabel = url.parse(item).path;</span><br><span class="line">                    pathLabel = md5(config.baseUrl + pathLabel);<span class="comment">//ä¸­æ–‡è¿‡é•¿æ‰€ä»¥è¦md5</span></span><br><span class="line">                    <span class="keyword">let</span> body = <span class="string">`<span class="subst">$&#123;item&#125;</span>&lt;br&gt;&lt;br&gt;<span class="subst">$&#123;websiteConfig.description&#125;</span>`</span>;</span><br><span class="line">                    <span class="keyword">let</span> form = <span class="built_in">JSON</span>.stringify(&#123; body, <span class="attr">labels</span>: [config.kind, pathLabel], title &#125;);</span><br><span class="line">                    <span class="keyword">return</span> send(&#123; ...requestPostOpt, form &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`å·²å®Œæˆ<span class="subst">$&#123;initRet.length&#125;</span>ä¸ªï¼`</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"å¯ä»¥æ„‰å¿«çš„å‘è¡¨è¯„è®ºäº†ï¼"</span>);</span><br><span class="line">            &#125;,<span class="number">40000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"æœ¬æ¬¡å‘å¸ƒæ— æ–°å¢é¡µé¢ï¼Œæ— éœ€åˆå§‹åŒ–issue!!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`åˆå§‹åŒ–issueå‡ºé”™ï¼Œé”™è¯¯å¦‚ä¸‹ï¼š`</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sitemapXmlReader</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = fs.readFileSync(file, <span class="string">"utf8"</span>);</span><br><span class="line">    <span class="keyword">let</span> sitemap = xmlParser(data);</span><br><span class="line">    <span class="keyword">return</span> sitemap.root.children.map(<span class="function"><span class="keyword">function</span> (<span class="params">url</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> loc = url.children.filter(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> item.name === <span class="string">"loc"</span>;</span><br><span class="line">        &#125;)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> loc.content;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeProtocol</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> url.substr(url.indexOf(<span class="string">":"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        request(options, <span class="function"><span class="keyword">function</span> (<span class="params">error, response, body</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">                resolve(body);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reject(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-æ‰§è¡Œè„šæœ¬"><a href="#3-æ‰§è¡Œè„šæœ¬" class="headerlink" title="3. æ‰§è¡Œè„šæœ¬"></a>3. æ‰§è¡Œè„šæœ¬</h4><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸€æ­¥ä¸­çš„sitemapæ’ä»¶ä¼šç”Ÿæˆçš„sitemap.xmlä¼šåŒ…å«<strong>å…¨éƒ¨çš„ç•Œé¢</strong>ï¼ŒåŒ…æ‹¬æ ‡ç­¾é¡µã€å…³äºé¡µç­‰ï¼Œæ‰§è¡Œä¸Šé¢çš„ä»£ç ä¹Ÿä¼šå¯¹è¿™äº›é¡µé¢ç”Ÿæˆè¯„è®ºæ¡†(ä¹Ÿå°±æ˜¯issue)</p></blockquote><p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥éƒ¨ç½²ç«™ç‚¹ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰çš„è¯„è®ºäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy</span><br><span class="line">node ./comment.js</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ç«™ç‚¹æ ¹ç›®å½•çš„package.jsonæ–‡ä»¶ä¸­ï¼Œæ–°å»ºnpmè„šæœ¬ï¼Œä¸€ä¸ªå‘½ä»¤æå®šæ¸…é™¤ç¼“å­˜ã€ç”Ÿæˆé™æ€æ–‡ä»¶ã€æäº¤gitå¹¶ç”Ÿæˆissueçš„æ‰€æœ‰æ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start&quot;: &quot;hexo clean &amp;&amp; hexo s&quot;,</span><br><span class="line">    &quot;deploy&quot;: &quot;hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy &amp;&amp; node .&#x2F;comment.js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæˆæ–‡ç« ç¼–å†™ï¼Œæˆ–è€…å…¶ä»–çš„æ›´æ–°æ“ä½œåï¼Œç›´æ¥æ‰§è¡Œdeployå³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm run deploy</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"><span class="number">192</span>:blog See$ ./comment<span class="variable">.js</span></span><br><span class="line">å¼€å§‹åˆå§‹åŒ–è¯„è®º...</span><br><span class="line">å¼€å§‹æ£€ç´¢é“¾æ¥ï¼Œè¯·ç¨ç­‰...</span><br><span class="line">å…±æ£€ç´¢åˆ°<span class="number">15</span>ä¸ªé“¾æ¥</span><br><span class="line">å¼€å§‹è·å–å·²ç»åˆå§‹åŒ–çš„issues:</span><br><span class="line">å·²ç»å­˜åœ¨<span class="number">3</span>ä¸ªissues</span><br><span class="line">æœ¬æ¬¡æœ‰<span class="number">12</span>ä¸ªé“¾æ¥éœ€è¦åˆå§‹åŒ–issueï¼š</span><br><span class="line">[</span><br><span class="line">  'https:<span class="comment">//opsolo.com/link/index.html',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/categories/index.html',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/tags/index.html',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/python/check-lb-auto-repair/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/zabbix/zabbix-alarm-convergence-compression/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/prometheus/install-prometheus-operator/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/shell/quickly-delete-lot-files/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/efk/filebeat/limit-cpu/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/efk/filebeat/reload-log/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/hexo/hexo-valine/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/hexo/hexo-github-custom-domin/',</span></span><br><span class="line">  'https:<span class="comment">//opsolo.com/hello-world/'</span></span><br><span class="line">]</span><br><span class="line">å¼€å§‹æäº¤åˆå§‹åŒ–è¯·æ±‚, å¤§çº¦éœ€è¦<span class="number">40</span>ç§’...</span><br><span class="line">å·²å®Œæˆ<span class="number">12</span>ä¸ªï¼</span><br><span class="line">å¯ä»¥æ„‰å¿«çš„å‘è¡¨è¯„è®ºäº†ï¼</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs </tag>
            
            <tag> hexo </tag>
            
            <tag> gitalk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoå¼€å¯Valineè¯„è®º</title>
      <link href="/hexo/hexo-valine/"/>
      <url>/hexo/hexo-valine/</url>
      
        <content type="html"><![CDATA[<h2 id="æ³¨å†ŒLeancloud"><a href="#æ³¨å†ŒLeancloud" class="headerlink" title="æ³¨å†ŒLeancloud"></a>æ³¨å†ŒLeancloud</h2><h3 id="æ·»åŠ Class"><a href="#æ·»åŠ Class" class="headerlink" title="æ·»åŠ Class"></a>æ·»åŠ Class</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Â·Â·Â·</span><br></pre></td></tr></table></figure><h2 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h2><h3 id="ç•Œé¢æ— æ³•æ˜¾ç¤ºè¯„è®ºæ¡†å¹¶å‘ä½ æŠ›äº†ä¸€ä¸ªå¼‚å¸¸"><a href="#ç•Œé¢æ— æ³•æ˜¾ç¤ºè¯„è®ºæ¡†å¹¶å‘ä½ æŠ›äº†ä¸€ä¸ªå¼‚å¸¸" class="headerlink" title="ç•Œé¢æ— æ³•æ˜¾ç¤ºè¯„è®ºæ¡†å¹¶å‘ä½ æŠ›äº†ä¸€ä¸ªå¼‚å¸¸"></a>ç•Œé¢æ— æ³•æ˜¾ç¤ºè¯„è®ºæ¡†å¹¶å‘ä½ æŠ›äº†ä¸€ä¸ªå¼‚å¸¸</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; TypeError: Cannot read property &#39;hide&#39; of undefined</span><br><span class="line">&gt;     at r.ErrorHandler (Valine.min.js:12)</span><br><span class="line">&gt;     at r.init (Valine.min.js:12)</span><br><span class="line">&gt;     at new r (Valine.min.js:12)</span><br><span class="line">&gt;     at new i (Valine.min.js:12)</span><br><span class="line">&gt;     at (index):1891</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p> éœ€è¦ä¿®æ”¹themes/next/_config.yml<br> å°†valine.languageä¿®æ”¹ä¸ºzh-cn<br> å®Œæ•´é…ç½®å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">valine:</span><br><span class="line">  enable: true # When enable is set to be true, leancloud_visitors is recommended to be closed for the re-initialization problem within different leancloud adk version.</span><br><span class="line">  appid:  ***</span><br><span class="line">  appkey:  ***</span><br><span class="line">  notify: false # mail notifier, See: https:&#x2F;&#x2F;github.com&#x2F;xCss&#x2F;Valine&#x2F;wiki</span><br><span class="line">  verify: false # Verification code</span><br><span class="line">  placeholder: Just go go # comment box placeholder</span><br><span class="line">  avatar: mm # gravatar style</span><br><span class="line">  guest_info: nick,mail,link # custom comment header</span><br><span class="line">  pageSize: 10 # pagination size</span><br><span class="line">  language: zh-cn # language, available values: en, zh-cn</span><br><span class="line">  visitor: false</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo Github è‡ªå®šä¹‰åŸŸå</title>
      <link href="/hexo/hexo-github-custom-domin/"/>
      <url>/hexo/hexo-github-custom-domin/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿®æ”¹Github-Settings"><a href="#ä¿®æ”¹Github-Settings" class="headerlink" title="ä¿®æ”¹Github Settings"></a>ä¿®æ”¹Github Settings</h2><p>Settungs -&gt; GitHub Pages -&gt; Custom domain</p><p>è¾“å…¥è‡ªå®šä¹‰åŸŸååç‚¹å‡» â€œSaveâ€</p><h2 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h2><h3 id="hexo-deployåç«™ç‚¹404"><a href="#hexo-deployåç«™ç‚¹404" class="headerlink" title="hexo deployåç«™ç‚¹404"></a>hexo deployåç«™ç‚¹404</h3><p> è™½ç„¶åœ¨Githubé‡Œè®¾ç½®äº†è‡ªå®šä¹‰åŸŸå,ä½†æ¯æ¬¡hexo deployåç«™ç‚¹å°±404äº†<br> å†æ¬¡å»github settingsé‡ŒæŸ¥çœ‹åŸŸåé…ç½®å‘ç°è¢«è¿˜åŸäº†</p><h4 id="å°†åŸŸåä¿å­˜åˆ°-public-CNAMEä¸­"><a href="#å°†åŸŸåä¿å­˜åˆ°-public-CNAMEä¸­" class="headerlink" title="å°†åŸŸåä¿å­˜åˆ°./public/CNAMEä¸­"></a>å°†åŸŸåä¿å­˜åˆ°./public/CNAMEä¸­</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cat .&#x2F;public&#x2F;CNAME</span><br><span class="line">blog.opsolo.com</span><br></pre></td></tr></table></figure><p>ä¿å­˜åå†æ¬¡hexo deploy å°±ä¸ä¼šè¢«è¿˜åŸäº†</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hello-world</title>
      <link href="/hello-world/"/>
      <url>/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-serversadf"><a href="#Run-serversadf" class="headerlink" title="Run serversadf"></a>Run serversadf</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> hello-world </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hello-world </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
